
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>17-æ•°æ®è·å–ç¯‡  Server Actionsï¼ˆä¸‹ï¼‰</title>
  <style>
    body {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
    }
    pre {
      background-color: #f6f8fa;
      padding: 16px;
      border-radius: 6px;
      overflow: auto;
    }
    code {
      font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
    }
  </style>
</head>
<body>
<h2>å‰è¨€</h2>
<p>ä¸Šç¯‡æˆ‘ä»¬è®²äº† Server Actions çš„åŸºæœ¬ç”¨æ³•ï¼Œæœ¬ç¯‡æˆ‘ä»¬è®²è®² Server Actions çš„â€œæ ‡å‡†â€ç”¨æ³•ã€‚æ¯”å¦‚å“ªäº› API å’Œåº“æ˜¯å¸¸æ­é… Server Actions ä½¿ç”¨çš„ï¼Ÿå†™ä¸€ä¸ª Server Actions è¦æ³¨æ„å“ªäº›åœ°æ–¹ï¼Ÿ</p>
<p>æˆ‘ä»¬è¿˜ä¼šä»‹ç»å¼€å‘ Server Actions æ—¶å¸¸é‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚å¦‚ä½•è¿›è¡Œä¹è§‚æ›´æ–°ï¼Ÿå¦‚ä½•è¿›è¡Œé”™è¯¯å¤„ç†ï¼Ÿå¦‚ä½•è·å– Cookiesã€Headers ç­‰æ•°æ®ï¼Ÿå¦‚ä½•é‡å®šå‘ï¼Ÿç­‰ç­‰</p>
<p>è®©æˆ‘ä»¬å¼€å§‹å§ã€‚</p>
<h2>Form</h2>
<p>æˆ‘ä»¬å…ˆè®²è®² Server Actions å¤„ç†è¡¨å•æäº¤æ—¶å¸¸æ­é…ä½¿ç”¨çš„ä¸€äº› APIã€‚</p>
<h3>1. useFormStatus</h3>
<p>é¦–å…ˆæ˜¯ <a href="https://react.dev/reference/react-dom/hooks/useFormStatus">useFormStatus</a>ï¼Œè¿™æ˜¯ React çš„å®˜æ–¹ hookï¼Œç”¨äºè¿”å›è¡¨å•æäº¤çš„çŠ¶æ€ä¿¡æ¯ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">&#39;use client&#39;
// app/submit-button.jsx
import { useFormStatus } from &#39;react-dom&#39;
 
export function SubmitButton() {
  const { pending } = useFormStatus()
 
  return (
    &lt;button type=&quot;submit&quot; aria-disabled={pending}&gt;
      {pending ? &#39;Adding&#39; : &#39;Add&#39;}
    &lt;/button&gt;
  )
}
</code></pre>
<pre><code class="language-javascript">// app/page.jsx
import { SubmitButton } from &#39;@/app/submit-button&#39;
 
export default async function Home() {
  return (
    &lt;form action={...}&gt;
      &lt;input type=&quot;text&quot; name=&quot;field-name&quot; /&gt;
      &lt;SubmitButton /&gt;
    &lt;/form&gt;
  )
}
</code></pre>
<p>ä½¿ç”¨çš„æ—¶å€™è¦æ³¨æ„ï¼šuseFormStatus å¿…é¡»ç”¨åœ¨ <code>&lt;form&gt;</code> ä¸‹çš„ç»„ä»¶å†…éƒ¨ï¼Œå°±åƒè¿™æ®µç¤ºä¾‹ä»£ç ä¸€æ ·ã€‚å…ˆå»ºç«‹ä¸€ä¸ªæŒ‰é’®ç»„ä»¶ï¼Œåœ¨ç»„ä»¶å†…éƒ¨è°ƒç”¨ useFormStatusï¼Œç„¶å <code>&lt;form&gt;</code> ä¸‹å¼•ç”¨è¯¥ç»„ä»¶ã€‚ä¸èƒ½å®Œå…¨å†™åˆ°ä¸€ä¸ªç»„ä»¶ä¸­ï¼Œåƒè¿™æ ·å†™å°±æ˜¯é”™è¯¯çš„ï¼š</p>
<pre><code class="language-javascript">function Form() {
  // ğŸš© `pending` will never be true
  // useFormStatus does not track the form rendered in this component
  const { pending } = useFormStatus();
  return &lt;form action={submit}&gt;&lt;/form&gt;;
}
</code></pre>
<h3>2. useFormState</h3>
<p>ç„¶åæ˜¯ <a href="https://react.dev/reference/react-dom/hooks/useFormState">useFormState</a>ï¼Œè¿™ä¹Ÿæ˜¯ React å®˜æ–¹ hookï¼Œæ ¹æ®è¡¨å• action çš„ç»“æœæ›´æ–°çŠ¶æ€ã€‚</p>
<p>ç”¨åœ¨ React æ—¶ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">import { useFormState } from &quot;react-dom&quot;;

async function increment(previousState, formData) {
  return previousState + 1;
}

function StatefulForm({}) {
  const [state, formAction] = useFormState(increment, 0);
  return (
    &lt;form&gt;
      {state}
      &lt;button formAction={formAction}&gt;Increment&lt;/button&gt;
    &lt;/form&gt;
  )
}
</code></pre>
<p>ç”¨åœ¨ Next.jsï¼Œç»“åˆ Server Actions æ—¶ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">&#39;use client&#39;

import { useFormState } from &#39;react-dom&#39;

export default function Home() {

  async function createTodo(prevState, formData) {
    return prevState.concat(formData.get(&#39;todo&#39;));
  }

  const [state, formAction] = useFormState(createTodo, [])

  return (
    &lt;form action={formAction}&gt;
      &lt;input type=&quot;text&quot; name=&quot;todo&quot; /&gt;
      &lt;button type=&quot;submit&quot;&gt;Submit&lt;/button&gt;
      &lt;p&gt;{state.join(&#39;,&#39;)}&lt;/p&gt;
    &lt;/form&gt;
  ) 
}
</code></pre>
<h3>3. å®æˆ˜ä½“ä¼š</h3>
<p>ç°åœ¨è®©æˆ‘ä»¬ç»“åˆ useFormStatus å’Œ useFormStateï¼Œè®²è§£ä½¿ç”¨ Server Actions å¦‚ä½•å¤„ç† form æäº¤ã€‚æ¶‰åŠçš„ç›®å½•å’Œæ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">app                 
â””â”€ form3           
   â”œâ”€ actions.js   
   â”œâ”€ form.js      
   â””â”€ page.js            
</code></pre>
<p>å…¶ä¸­ <code>app/form3/page.js</code> ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">import { findToDos } from &#39;./actions&#39;;
import AddToDoForm from &#39;./form&#39;;

export default async function Page() {
  const todos = await findToDos();
  return (
    &lt;&gt;
      &lt;AddToDoForm /&gt;
      &lt;ul&gt;
        {todos.map((todo, i) =&gt; &lt;li key={i}&gt;{todo}&lt;/li&gt;)}
      &lt;/ul&gt;
    &lt;/&gt;
  )
}
</code></pre>
<p><code>app/form3/form.js</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">&#39;use client&#39;
 
import { useFormState, useFormStatus } from &#39;react-dom&#39;
import { createToDo } from &#39;./actions&#39;;

const initialState = {
  message: &#39;&#39;,
}
 
function SubmitButton() {
  const { pending } = useFormStatus()
  return (
    &lt;button type=&quot;submit&quot; aria-disabled={pending}&gt;
      {pending ? &#39;Adding&#39; : &#39;Add&#39;}
    &lt;/button&gt;
  )
}

export default function AddToDoForm() {
  const [state, formAction] = useFormState(createToDo, initialState)
 
  return (
    &lt;form action={formAction}&gt;
      &lt;input type=&quot;text&quot; name=&quot;todo&quot; /&gt;
      &lt;SubmitButton /&gt;
      &lt;p aria-live=&quot;polite&quot; className=&quot;sr-only&quot;&gt;
        {state?.message}
      &lt;/p&gt;
    &lt;/form&gt;
  )
}
</code></pre>
<p><code>app/form3/actions.js</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">&#39;use server&#39;

import { revalidatePath } from &quot;next/cache&quot;;

const sleep = ms =&gt; new Promise(r =&gt; setTimeout(r, ms));

let data = [&#39;é˜…è¯»&#39;, &#39;å†™ä½œ&#39;, &#39;å†¥æƒ³&#39;]
 
export async function findToDos() {
  return data
}

export async function createToDo(prevState, formData) {
  await sleep(500)
  const todo = formData.get(&#39;todo&#39;)
  data.push(todo)
  revalidatePath(&quot;/form3&quot;);
  return {
    message: `add ${todo} success!`
  }
}
</code></pre>
<p>äº¤äº’æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d9b1592d85124e03a2cd6d927ea6686b~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=847&h=558&s=81417&e=gif&f=37&b=fefefe" alt="actions-6.gif">
æ³¨æ„ï¼šå½“ä½¿ç”¨ useFormState çš„æ—¶å€™ï¼Œå¯¹åº” Server Action å‡½æ•°çš„å‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ prevStateï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ formDataã€‚å½“ä½¿ç”¨ useFormStatus çš„æ—¶å€™ï¼Œè¦å†™åœ¨ form ä¸‹çš„å•ç‹¬çš„ç»„ä»¶ä¸­ã€‚ä½¿ç”¨çš„æ—¶å€™ï¼Œæ³¨æ„è¿™ä¸¤ç‚¹å°±è¡Œã€‚</p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼š</p>
<pre><code class="language-javascript">&lt;p aria-live=&quot;polite&quot; className=&quot;sr-only&quot;&gt;
  {state?.message}
&lt;/p&gt;
</code></pre>
<p><code>aria-live</code>è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª ARIA æ ‡ç­¾ï¼Œç”¨äºç¤¼è²Œé€šçŸ¥ç”¨æˆ·å‘ç”Ÿäº†å˜æ›´ã€‚<code>&quot;sr-only&quot;</code>è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªåªç”¨äº screen reader çš„å†…å®¹ã€‚å› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰è®¾ç½® sr-only çš„æ ·å¼ï¼Œæ‰€ä»¥åœ¨é¡µé¢ä¸­æ˜¾éœ²äº†å‡ºæ¥ï¼ŒæŒ‰ç†è¯´è¦åŠ ä¸€ä¸ªå¦‚ä¸‹çš„æ ·å¼ï¼š</p>
<pre><code class="language-css">.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}
</code></pre>
<p>ç®€å•çš„æ¥è¯´ï¼Œè¿™æ®µå†…å®¹åœ¨å±å¹•ä¸Šå¹¶ä¸åº”è¯¥æ˜¾ç¤ºå‡ºæ¥ã€‚è¿”å›è¿™ä¸ªä¿¡æ¯æ˜¯ç”¨äºé€šçŸ¥ä¸èƒ½åƒæ­£å¸¸äººçœ‹åˆ°å±å¹•å†…å®¹ã€éœ€è¦å€ŸåŠ©å±å¹•é˜…è¯»å™¨å·¥å…·çš„äººï¼Œä»»åŠ¡åˆ›å»ºæˆåŠŸã€‚</p>
<h2>Server Actions</h2>
<p>æ¥ä¸‹æ¥è®²è®²å†™ Server Actions æœ‰å“ªäº›æ³¨æ„è¦ç‚¹ã€‚ç®€å•æ¥è¯´ï¼Œè¦æ³¨æ„ï¼š</p>
<ol>
<li>è·å–æäº¤çš„æ•°æ®</li>
<li>è¿›è¡Œæ•°æ®æ ¡éªŒå’Œé”™è¯¯å¤„ç†</li>
<li>é‡æ–°éªŒè¯æ•°æ®</li>
<li>é”™è¯¯å¤„ç†</li>
</ol>
<h3>1. è·å–æ•°æ®</h3>
<p>å¦‚æœä½¿ç”¨ form action è¿™ç§æœ€åŸºæœ¬çš„å½¢å¼ï¼ŒServer Action å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ formDataï¼š</p>
<pre><code class="language-javascript">export default function Page() {
  async function createInvoice(formData) {
    &#39;use server&#39;
 
    const rawFormData = {
      customerId: formData.get(&#39;customerId&#39;)
    }
 
    // mutate data
    // revalidate cache
  }
 
  return &lt;form action={createInvoice}&gt;...&lt;/form&gt;
}
</code></pre>
<p>å¦‚æœä½¿ç”¨ form action + useFormState è¿™ç§å½¢å¼ï¼ŒServer Actions å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ prevStateï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ formDataï¼š</p>
<pre><code class="language-javascript">&#39;use client&#39;

import { useFormState } from &#39;react-dom&#39;

export default function Home() {

  async function createTodo(prevState, formData) {
    return prevState.concat(formData.get(&#39;todo&#39;));
  }

  const [state, formAction] = useFormState(createTodo, [])

  return (
    &lt;form action={formAction}&gt;
      &lt;input type=&quot;text&quot; name=&quot;todo&quot; /&gt;
      &lt;button type=&quot;submit&quot;&gt;Submit&lt;/button&gt;
      &lt;p&gt;{state.join(&#39;,&#39;)}&lt;/p&gt;
    &lt;/form&gt;
  ) 
}
</code></pre>
<p>å¦‚æœæ˜¯ç›´æ¥è°ƒç”¨ï¼Œé‚£çœ‹è°ƒç”¨çš„æ—¶å€™æ˜¯æ€ä¹ˆä¼ å…¥çš„ï¼Œæ¯”å¦‚ä¸Šç¯‡ä¸¾çš„äº‹ä»¶è°ƒç”¨çš„ä¾‹å­ï¼š</p>
<pre><code class="language-javascript">&#39;use client&#39;

import { createToDoDirectly } from &#39;./actions&#39;;

export default function Button({children}) {
  return &lt;button onClick={async () =&gt; {
    const data = await createToDoDirectly(&#39;è¿åŠ¨&#39;)
    alert(JSON.stringify(data))
  }}&gt;{children}&lt;/button&gt;
}
</code></pre>
<pre><code class="language-javascript">&#39;use server&#39;

export async function createToDoDirectly(value) {
  const form = new FormData()
  form.append(&quot;todo&quot;, value);
  return createToDo(form)
}
</code></pre>
<h3>2. è¡¨å•éªŒè¯</h3>
<p>Next.js æ¨èåŸºæœ¬çš„è¡¨å•éªŒè¯ä½¿ç”¨ HTML å…ƒç´ è‡ªå¸¦çš„éªŒè¯å¦‚ <code>required</code>ã€<code>type=&quot;email&quot;</code>ç­‰ã€‚</p>
<p>å¯¹äºæ›´é«˜é˜¶çš„æœåŠ¡ç«¯æ•°æ®éªŒè¯ï¼Œå¯ä»¥ä½¿ç”¨ <a href="https://zod.dev/">zod</a> è¿™æ ·çš„ schema éªŒè¯åº“æ¥éªŒè¯è¡¨å•æ•°æ®çš„ç»“æ„ï¼š</p>
<pre><code class="language-javascript">&#39;use server&#39;
 
import { z } from &#39;zod&#39;
 
const schema = z.object({
  email: z.string({
    invalid_type_error: &#39;Invalid Email&#39;,
  }),
})
 
export default async function createsUser(formData) {
  const validatedFields = schema.safeParse({
    email: formData.get(&#39;email&#39;),
  })
 
  // Return early if the form data is invalid
  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
    }
  }
 
  // Mutate data
}
</code></pre>
<h3>3. é‡æ–°éªŒè¯æ•°æ®</h3>
<p>Server Action ä¿®æ”¹æ•°æ®åï¼Œä¸€å®šè¦æ³¨æ„é‡æ–°éªŒè¯æ•°æ®ï¼Œå¦åˆ™æ•°æ®ä¸ä¼šåŠæ—¶æ›´æ–°ã€‚</p>
<p>ä½¿ç”¨ revalidatePathï¼š</p>
<pre><code class="language-javascript">&#39;use server&#39;
 
import { revalidatePath } from &#39;next/cache&#39;
 
export async function createPost() {
  try {
    // ...
  } catch (error) {
    // ...
  }
 
  revalidatePath(&#39;/posts&#39;)
}
</code></pre>
<p>ä½¿ç”¨ revalidateTagï¼š</p>
<pre><code class="language-javascript">&#39;use server&#39;
 
import { revalidateTag } from &#39;next/cache&#39;
 
export async function createPost() {
  try {
    // ...
  } catch (error) {
    // ...
  }
 
  revalidateTag(&#39;posts&#39;)
}
</code></pre>
<h3>4. é”™è¯¯å¤„ç†</h3>
<p>ä¸€ç§æ˜¯è¿”å›é”™è¯¯ä¿¡æ¯ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå½“ä¸€ä¸ªæ¡ç›®åˆ›å»ºå¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼š</p>
<pre><code class="language-javascript">&#39;use server&#39;
// app/actions.js
export async function createTodo(prevState, formData) {
  try {
    await createItem(formData.get(&#39;todo&#39;))
    return revalidatePath(&#39;/&#39;)
  } catch (e) {
    return { message: &#39;Failed to create&#39; }
  }
}
</code></pre>
<p>åœ¨å®¢æˆ·ç«¯ç»„ä»¶ä¸­ï¼Œè¯»å–è¿™ä¸ªå€¼å¹¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼š</p>
<pre><code class="language-javascript">&#39;use client&#39;
// app/add-form.jsx
import { useFormState, useFormStatus } from &#39;react-dom&#39;
import { createTodo } from &#39;@/app/actions&#39;
 
const initialState = {
  message: null,
}
 
function SubmitButton() {
  const { pending } = useFormStatus()
 
  return (
    &lt;button type=&quot;submit&quot; aria-disabled={pending}&gt;
      Add
    &lt;/button&gt;
  )
}
 
export function AddForm() {
  const [state, formAction] = useFormState(createTodo, initialState)
 
  return (
    &lt;form action={formAction}&gt;
      &lt;label htmlFor=&quot;todo&quot;&gt;Enter Task&lt;/label&gt;
      &lt;input type=&quot;text&quot; id=&quot;todo&quot; name=&quot;todo&quot; required /&gt;
      &lt;SubmitButton /&gt;
      &lt;p aria-live=&quot;polite&quot; className=&quot;sr-only&quot;&gt;
        {state?.message}
      &lt;/p&gt;
    &lt;/form&gt;
  )
}
</code></pre>
<p>ä¸€ç§æ˜¯æŠ›å‡ºé”™è¯¯ï¼Œä¼šç”±æœ€è¿‘çš„ error.js æ•è·ï¼š</p>
<pre><code class="language-javascript">&#39;use client&#39;
// error.js
export default function Error() {
  return (
    &lt;h2&gt;error&lt;/h2&gt;
  )
}
</code></pre>
<pre><code class="language-javascript">// page.js
import { useFormState } from &#39;react-dom&#39;

function AddForm() {
  async function serverActionWithError() {
    &#39;use server&#39;;   
    throw new Error(`This is error is in the Server Action`);
  }

  return (
    &lt;form action={serverActionWithError}&gt;
      &lt;button type=&quot;submit&quot;&gt;Submit&lt;/button&gt;
    &lt;/form&gt;
  ) 
}

export default AddForm
</code></pre>
<p>è¿™æ ·å½“ Server Action å‘ç”Ÿé”™è¯¯çš„æ—¶å€™ï¼Œå°±ä¼šå±•ç¤ºé”™è¯¯ UIã€‚</p>
<h2>ä¹è§‚æ›´æ–°</h2>
<h3>1. useOptimistic</h3>
<p>æ‰€è°“ä¹è§‚æ›´æ–°ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œå½“ç”¨æˆ·ç‚¹å‡»ä¸€ä¸ªç‚¹èµæŒ‰é’®çš„æ—¶å€™ï¼Œä¼ ç»Ÿçš„åšæ³•æ˜¯ç­‰å¾…æ¥å£è¿”å›æˆåŠŸæ—¶å†æ›´æ–° UIã€‚ä¹è§‚æ›´æ–°æ˜¯å…ˆæ›´æ–° UIï¼ŒåŒæ—¶å‘é€æ•°æ®è¯·æ±‚ï¼Œè‡³äºæ•°æ®è¯·æ±‚åçš„é”™è¯¯å¤„ç†ï¼Œåˆ™æ ¹æ®è‡ªå·±çš„éœ€è¦è‡ªå®šä¹‰å®ç°ã€‚</p>
<p>React æä¾›äº† <a href="https://react.dev/reference/react/useOptimistic">useOptimistic</a> hookï¼Œè¿™ä¹Ÿæ˜¯å®˜æ–¹ hookï¼ŒåŸºæœ¬ç”¨æ³•å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">import { useOptimistic } from &#39;react&#39;;

function AppContainer() {
  const [optimisticState, addOptimistic] = useOptimistic(
    state,
    // updateFn
    (currentState, optimisticValue) =&gt; {
      // merge and return new state
      // with optimistic value
    }
  );
}
</code></pre>
<p>ç»“åˆ Server Actions ä½¿ç”¨çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">&#39;use client&#39;
 
import { useOptimistic } from &#39;react&#39;
import { send } from &#39;./actions&#39;
 
export function Thread({ messages }) {
  const [optimisticMessages, addOptimisticMessage] = useOptimistic(
    messages,
    (state, newMessage) =&gt; [...state, { message: newMessage }]
  )
 
  return (
    &lt;div&gt;
      {optimisticMessages.map((m) =&gt; (
        &lt;div&gt;{m.message}&lt;/div&gt;
      ))}
      &lt;form
        action={async (formData) =&gt; {
          const message = formData.get(&#39;message&#39;)
          addOptimisticMessage(message)
          await send(message)
        }}
      &gt;
        &lt;input type=&quot;text&quot; name=&quot;message&quot; /&gt;
        &lt;button type=&quot;submit&quot;&gt;Send&lt;/button&gt;
      &lt;/form&gt;
    &lt;/div&gt;
  )
}
</code></pre>
<h3>2. å®æˆ˜ä½“ä¼š</h3>
<p>ä¸ºäº†åŠ æ·±å¯¹ä¹è§‚æ›´æ–°çš„ç†è§£ï¼Œæˆ‘ä»¬æ¥å†™ä¸€ä¸ªä¾‹å­ã€‚é¡¹ç›®ç›®å½•å’Œæ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">app                 
â””â”€ form4           
   â”œâ”€ actions.js   
   â”œâ”€ form.js      
   â””â”€ page.js            
</code></pre>
<p>å…¶ä¸­ <code>app/form4/page.js</code> ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">import { findToDos } from &#39;./actions&#39;;
import Form from &#39;./form&#39;;

export default async function Page() {
  const todos = await findToDos();
  return (
    &lt;Form todos={todos} /&gt;
  )
}
</code></pre>
<p><code>app/form4/form.js</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">&#39;use client&#39;

import { useOptimistic } from &#39;react&#39;
import { useFormState } from &#39;react-dom&#39;
import { createToDo } from &#39;./actions&#39;;

export default function Form({ todos }) {
  const [state, sendFormAction] = useFormState(createToDo, { message: &#39;&#39; })

  const [optimistiToDos, addOptimisticTodo] = useOptimistic(
    todos.map((i) =&gt; ({text: i})),
    (state, newTodo) =&gt; [
      ...state,
      {
        text: newTodo,
        sending: true
      }
    ]
  );

  async function formAction(formData) {
    addOptimisticTodo(formData.get(&quot;todo&quot;));
    await sendFormAction(formData);
  }

  console.log(optimistiToDos)

  return (
    &lt;&gt;
      &lt;form action={formAction}&gt;
        &lt;input type=&quot;text&quot; name=&quot;todo&quot; /&gt;
        &lt;button type=&quot;submit&quot;&gt; Add &lt;/button&gt;
        &lt;p aria-live=&quot;polite&quot; className=&quot;sr-only&quot;&gt;
          {state?.message}
        &lt;/p&gt;
      &lt;/form&gt;
      &lt;ul&gt;
        {optimistiToDos.map(({text, sending}, i) =&gt; &lt;li key={i}&gt;{text}{!!sending &amp;&amp; &lt;small&gt; (Sending...)&lt;/small&gt;}&lt;/li&gt;)}
      &lt;/ul&gt;
    &lt;/&gt;
  )
}
</code></pre>
<p><code>app/form4/actions.js</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">&#39;use server&#39;

import { revalidatePath } from &quot;next/cache&quot;;

const sleep = ms =&gt; new Promise(r =&gt; setTimeout(r, ms));

let data = [&#39;é˜…è¯»&#39;, &#39;å†™ä½œ&#39;, &#39;å†¥æƒ³&#39;]
 
export async function findToDos() {
  return data
}

export async function createToDo(prevState, formData) {
  await sleep(2500)
  const todo = formData.get(&#39;todo&#39;)
  data.push(todo)
  revalidatePath(&quot;/form4&quot;);
  return {
    message: `add ${todo} success!`
  }
}
</code></pre>
<p>äº¤äº’æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a786cb80a2ea4a4eb0e4a9060ccf7d4d~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1124&h=529&s=247810&e=gif&f=65&b=fefefe" alt="actions-7.gif"></p>
<p>æ³¨ï¼šä¹è§‚æ›´æ–°æ˜¯ä¸€ç§é¢å‘æœªæ¥çš„ UI æ›´æ–°æ–¹å¼ã€‚å¦‚ä½•åœ¨æ¥å£é”™è¯¯çš„æ—¶å€™æ’¤å›æ•°æ®ï¼Ÿå¦‚æœæ¥å£å®åœ¨æ˜¯å¤ªæ…¢äº†ï¼Œä¹è§‚æ›´æ–°çš„æ—¶å€™ï¼Œç”¨æˆ·è¦ç¦»å¼€è¯¥æ€ä¹ˆåŠï¼Ÿ</p>
<p>å…³äºè¿™äº›æ›´ç»†èŠ‚çš„å®ç°é—®é¢˜ï¼Œæ¬¢è¿å‚è€ƒ <a href="https://juejin.cn/post/7347957960884355113">ã€ŠNext.js v14 å®ç°ä¹è§‚æ›´æ–°ï¼Œé¢å‘æœªæ¥çš„ UI æ›´æ–°æ–¹å¼ï¼Œä½ å¯ä»¥ä¸å»åšï¼Œä½†ä½ ä¸åº”è¯¥ä¸äº†è§£ã€‹</a></p>
<h2>å¸¸è§é—®é¢˜</h2>
<h3>1. å¦‚ä½•å¤„ç† Cookies ?</h3>
<pre><code class="language-javascript">&#39;use server&#39;
 
import { cookies } from &#39;next/headers&#39;
 
export async function exampleAction() {
  // Get cookie
  const value = cookies().get(&#39;name&#39;)?.value
 
  // Set cookie
  cookies().set(&#39;name&#39;, &#39;Delba&#39;)
 
  // Delete cookie
  cookies().delete(&#39;name&#39;)
}
</code></pre>
<h3>2. å¦‚ä½•é‡å®šå‘ï¼Ÿ</h3>
<pre><code class="language-javascript">&#39;use server&#39;
 
import { redirect } from &#39;next/navigation&#39;
import { revalidateTag } from &#39;next/cache&#39;
 
export async function createPost(id) {
  try {
    // ...
  } catch (error) {
    // ...
  }
 
  revalidateTag(&#39;posts&#39;) // Update cached posts
  redirect(`/post/${id}`) // Navigate to the new post page
}
</code></pre>
<h2>å‚è€ƒé“¾æ¥</h2>
<ol>
<li><a href="https://nextjs.org/docs/app/building-your-application/data-fetching/fetching-caching-and-revalidating">Data Fetching: Fetching, Caching, and Revalidating</a></li>
<li><a href="https://nextjs.org/docs/app/building-your-application/data-fetching/patterns">Data Fetching: Data Fetching Patterns</a></li>
<li><a href="https://nextjs.org/docs/app/building-your-application/data-fetching/forms-and-mutations">Data Fetching: Forms and Mutations</a></li>
<li><a href="https://nextjs.org/docs/app/api-reference/functions/server-actions">Functions: Server Actions</a></li>
<li><a href="https://makerkit.dev/blog/tutorials/nextjs-server-actions">https://makerkit.dev/blog/tutorials/nextjs-server-actions</a></li>
</ol>

</body>
</html>
  