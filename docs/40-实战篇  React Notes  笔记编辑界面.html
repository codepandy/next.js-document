
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>40-å®æˆ˜ç¯‡  React Notes  ç¬”è®°ç¼–è¾‘ç•Œé¢</title>
  <style>
    body {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
    }
    pre {
      background-color: #f6f8fa;
      padding: 16px;
      border-radius: 6px;
      overflow: auto;
    }
    code {
      font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
    }
  </style>
</head>
<body>
<h2>å‰è¨€</h2>
<p>æœ¬ç¯‡æˆ‘ä»¬æ¥å®ç°å³ä¾§ç¬”è®°ç¼–è¾‘éƒ¨åˆ†ã€‚</p>
<h2>ç¬”è®°ç¼–è¾‘ç•Œé¢</h2>
<p>å½“ç‚¹å‡» <code>New</code> æŒ‰é’®çš„æ—¶å€™è¿›å…¥ç¼–è¾‘ç•Œé¢ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/82008017d3144f4aaac6dc07821e69e9~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2936&h=1328&s=216062&e=png&b=ffffff" alt="image.png"></p>
<p>å½“ç‚¹å‡»å…·ä½“ç¬”è®°çš„ <code>Edit</code> æŒ‰é’®çš„æ—¶å€™è¿›å…¥è¯¥ç¬”è®°çš„ç¼–è¾‘é¡µé¢ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2c9178953c194ef4938784ce2d58d184~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2938&h=1332&s=232949&e=png&b=ffffff" alt="image.png"></p>
<p>å›å¿†ä¸‹ä¹‹å‰çš„è·¯ç”±è®¾è®¡ï¼Œå½“ç‚¹å‡» <code>New</code> çš„æ—¶å€™ï¼Œå¯¼èˆªè‡³ <code>/note/edit</code>è·¯ç”±ï¼Œå½“ç‚¹å‡» <code>Edit</code> çš„æ—¶å€™ï¼Œå¯¼èˆªè‡³ <code>/note/edit/xxxx</code> è·¯ç”±ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬å¼€å§‹åŠ¨æ‰‹å§ï¼</p>
<p><code>/app/note/edit/page.js</code>ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">import NoteEditor from &#39;@/components/NoteEditor&#39;

export default async function EditPage() {
  return &lt;NoteEditor note={null} initialTitle=&quot;Untitled&quot; initialBody=&quot;&quot; /&gt;
}
</code></pre>
<p><code>/app/note/edit/loading.js</code>ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">export default function EditSkeleton() {
  return (
    &lt;div
      className=&quot;note-editor skeleton-container&quot;
      role=&quot;progressbar&quot;
      aria-busy=&quot;true&quot;
    &gt;
      &lt;div className=&quot;note-editor-form&quot;&gt;
        &lt;div className=&quot;skeleton v-stack&quot; style={{ height: &#39;3rem&#39; }} /&gt;
        &lt;div className=&quot;skeleton v-stack&quot; style={{ height: &#39;100%&#39; }} /&gt;
      &lt;/div&gt;
      &lt;div className=&quot;note-editor-preview&quot;&gt;
        &lt;div className=&quot;note-editor-menu&quot;&gt;
          &lt;div
            className=&quot;skeleton skeleton--button&quot;
            style={{ width: &#39;8em&#39;, height: &#39;2.5em&#39; }}
          /&gt;
          &lt;div
            className=&quot;skeleton skeleton--button&quot;
            style={{ width: &#39;8em&#39;, height: &#39;2.5em&#39;, marginInline: &#39;12px 0&#39; }}
          /&gt;
        &lt;/div&gt;
        &lt;div
          className=&quot;note-title skeleton&quot;
          style={{ height: &#39;3rem&#39;, width: &#39;65%&#39;, marginInline: &#39;12px 1em&#39; }}
        /&gt;
        &lt;div className=&quot;note-preview&quot;&gt;
          &lt;div className=&quot;skeleton v-stack&quot; style={{ height: &#39;1.5em&#39; }} /&gt;
          &lt;div className=&quot;skeleton v-stack&quot; style={{ height: &#39;1.5em&#39; }} /&gt;
          &lt;div className=&quot;skeleton v-stack&quot; style={{ height: &#39;1.5em&#39; }} /&gt;
          &lt;div className=&quot;skeleton v-stack&quot; style={{ height: &#39;1.5em&#39; }} /&gt;
          &lt;div className=&quot;skeleton v-stack&quot; style={{ height: &#39;1.5em&#39; }} /&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  )
}
</code></pre>
<p>ä½ å¯èƒ½ä¼šé—®ï¼ŒåŒçº§çš„ <code>page.js</code> åˆæ²¡æœ‰æ•°æ®è¯·æ±‚ï¼Œæ·»åŠ  <code>loading.js</code> æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</p>
<p>åŒçº§çš„<code>page.js</code>ç¡®å®æ²¡æœ‰è¯·æ±‚ï¼Œä½† <code>loading.js</code>ä¼šå°† <code>page.js</code> å’Œå…¶ <code>children</code> éƒ½åŒ…è£¹åœ¨ <code>&lt;Suspense&gt;</code> ä¸­ï¼Œæ‰€ä»¥ <code>/app/note/edit/[id]/page.js</code>ä¸­çš„è¯·æ±‚ä¹Ÿä¼šè§¦å‘è¯¥ <code>loading.js</code>ã€‚</p>
<p><code>/app/note/edit/[id]/page.js</code>ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">import NoteEditor from &#39;@/components/NoteEditor&#39;
import {getNote} from &#39;@/lib/redis&#39;;

export default async function EditPage({ params }) {
  const noteId = params.id;
  const note = await getNote(noteId)

  // è®©æ•ˆæœæ›´æ˜æ˜¾
  const sleep = ms =&gt; new Promise(r =&gt; setTimeout(r, ms));
  await sleep(5000);

  if (note === null) {
    return (
      &lt;div className=&quot;note--empty-state&quot;&gt;
        &lt;span className=&quot;note-text--empty-state&quot;&gt;
          Click a note on the left to view something! ğŸ¥º
        &lt;/span&gt;
      &lt;/div&gt;
    )
  }

  return &lt;NoteEditor noteId={noteId} initialTitle={note.title} initialBody={note.content} /&gt;
}
</code></pre>
<p>æˆ‘ä»¬æŠ½ç¦»äº†ä¸€ä¸ª <code>&lt;NoteEditor&gt;</code> ç»„ä»¶ç”¨äºå®ç°ç¼–è¾‘åŠŸèƒ½ï¼Œ<code>/components/NoteEditor.js</code> ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-jsx">&#39;use client&#39;

import { useState } from &#39;react&#39;
import NotePreview from &#39;@/components/NotePreview&#39;
import { useFormStatus } from &#39;react-dom&#39;

export default function NoteEditor({
  noteId,
  initialTitle,
  initialBody
}) {

  const { pending } = useFormStatus()
  const [title, setTitle] = useState(initialTitle)
  const [body, setBody] = useState(initialBody)
  const isDraft = !noteId

  return (
    &lt;div className=&quot;note-editor&quot;&gt;
      &lt;form className=&quot;note-editor-form&quot; autoComplete=&quot;off&quot;&gt;
        &lt;label className=&quot;offscreen&quot; htmlFor=&quot;note-title-input&quot;&gt;
          Enter a title for your note
        &lt;/label&gt;
        &lt;input
          id=&quot;note-title-input&quot;
          type=&quot;text&quot;
          value={title}
          onChange={(e) =&gt; {
            setTitle(e.target.value)
          }}
        /&gt;
        &lt;label className=&quot;offscreen&quot; htmlFor=&quot;note-body-input&quot;&gt;
          Enter the body for your note
        &lt;/label&gt;
        &lt;textarea
          value={body}
          id=&quot;note-body-input&quot;
          onChange={(e) =&gt; setBody(e.target.value)}
        /&gt;
      &lt;/form&gt;
      &lt;div className=&quot;note-editor-preview&quot;&gt;
        &lt;form className=&quot;note-editor-menu&quot; role=&quot;menubar&quot;&gt;
          &lt;button
            className=&quot;note-editor-done&quot;
            disabled={pending}
            type=&quot;submit&quot;
            role=&quot;menuitem&quot;
          &gt;
            &lt;img
              src=&quot;/checkmark.svg&quot;
              width=&quot;14px&quot;
              height=&quot;10px&quot;
              alt=&quot;&quot;
              role=&quot;presentation&quot;
            /&gt;
            Done
          &lt;/button&gt;
          {!isDraft &amp;&amp; (
            &lt;button
              className=&quot;note-editor-delete&quot;
              disabled={pending}
              role=&quot;menuitem&quot;
            &gt;
              &lt;img
                src=&quot;/cross.svg&quot;
                width=&quot;10px&quot;
                height=&quot;10px&quot;
                alt=&quot;&quot;
                role=&quot;presentation&quot;
              /&gt;
              Delete
            &lt;/button&gt;
          )}
        &lt;/form&gt;
        &lt;div className=&quot;label label--preview&quot; role=&quot;status&quot;&gt;
          Preview
        &lt;/div&gt;
        &lt;h1 className=&quot;note-title&quot;&gt;{title}&lt;/h1&gt;
        &lt;NotePreview&gt;{body}&lt;/NotePreview&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  )
}
</code></pre>
<p>å› ä¸ºéœ€è¦æ§åˆ¶è¾“å…¥æ¡†çš„çŠ¶æ€ï¼Œæ‰€ä»¥ <code>&lt;NoteEditor&gt;</code> ä½¿ç”¨äº†å®¢æˆ·ç«¯ç»„ä»¶ï¼Œæˆ‘ä»¬åœ¨ <code>&lt;NotePreview&gt;</code> ä¸­å¼•ç”¨äº† <code>&lt;NotePreview&gt;</code>ç»„ä»¶ï¼Œç”¨äºå®ç°ç¼–è¾‘æ—¶çš„å®æ—¶é¢„è§ˆåŠŸèƒ½ã€‚</p>
<p>æ­¤æ—¶ç¼–è¾‘é¡µé¢åº”è¯¥å·²ç»å¯ä»¥æ­£å¸¸æ˜¾ç¤ºï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ebf9dbec4ee14be7a85e2a57809ad1d1~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2944&h=1164&s=230241&e=png&b=ffffff" alt="image.png"></p>
<p>æ­¤æ—¶ <code>Done</code> å’Œ <code>Delete</code> æŒ‰é’®è¿˜ä¸èƒ½ä½¿ç”¨ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Server Actions æ¥å®ç°ã€‚ä½†å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹ç›®å‰çš„å®ç°ä¸­ä¸€äº›è¦æ³¨æ„çš„ç‚¹ã€‚</p>
<h3>æœåŠ¡ç«¯ç»„ä»¶å’Œå®¢æˆ·ç«¯ç»„ä»¶</h3>
<p>å‰é¢æˆ‘ä»¬è®²åˆ°å…³äºæœåŠ¡ç«¯ç»„ä»¶å’Œå®¢æˆ·ç«¯ç»„ä»¶çš„ä½¿ç”¨æŒ‡å—ï¼Œå…¶ä¸­æœ‰ä¸€æ¡ï¼š</p>
<blockquote>
<p><strong>æœåŠ¡ç«¯ç»„ä»¶å¯ä»¥å¯¼å…¥å®¢æˆ·ç«¯ç»„ä»¶ï¼Œä½†å®¢æˆ·ç«¯ç»„ä»¶ä¸èƒ½å¯¼å…¥æœåŠ¡ç«¯ç»„ä»¶</strong></p>
</blockquote>
<p>ä½†æ˜¯è¿™ä¸ªä¾‹å­ä¸­å°±å¾ˆå¥‡æ€ªäº†ã€‚<code>&lt;NoteEditor&gt;</code> æ˜¯å®¢æˆ·ç«¯ç»„ä»¶ï¼Œ<code>&lt;NotePreview&gt;</code>æ˜¯æœåŠ¡ç«¯ç»„ä»¶ï¼Œä½†æˆ‘ä»¬å´åœ¨ <code>&lt;NoteEditor&gt;</code> ä¸­å¼•ç”¨äº† <code>&lt;NotePreview&gt;</code>ç»„ä»¶ï¼Œä¸æ˜¯è¯´ä¸å¯ä»¥å—ï¼Ÿæ€ä¹ˆè¿˜æˆåŠŸæ¸²æŸ“äº†ï¼</p>
<p>è¿™æ˜¯ä¸€ä¸ªåˆå­¦è€…ç»å¸¸ä¼šé‡åˆ°çš„è¯¯åŒºã€‚è®©æˆ‘ä»¬å›å¿†ä¸‹<a href="https://juejin.cn/book/7307859898316881957/section/7309076661532622885#heading-19">ã€Šæ¸²æŸ“ç¯‡ | æœåŠ¡ç«¯ç»„ä»¶å’Œå®¢æˆ·ç«¯ç»„ä»¶ã€‹</a>ä¸­æ˜¯å¦‚ä½•å®šä¹‰å®¢æˆ·ç«¯ç»„ä»¶çš„ï¼š</p>
<p>æˆ‘ä»¬ä¼šåœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ ä¸€ä¸ª <code>&#39;use client&#39;</code> å£°æ˜ã€‚ä½†å‡†ç¡®çš„è¯´ï¼Œ<code>&#39;use client&#39;</code> å£°æ˜çš„æ˜¯æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ç»„ä»¶ä¹‹é—´çš„è¾¹ç•Œï¼Œè¿™æ„å‘³ç€ï¼Œå½“ä½ åœ¨æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€ä¸ª <code>&#39;use client&#39;</code>ï¼Œå¯¼å…¥çš„å…¶ä»–æ¨¡å—åŒ…æ‹¬å­ç»„ä»¶ï¼Œéƒ½ä¼šè¢«è§†ä¸ºå®¢æˆ·ç«¯ bundle çš„ä¸€éƒ¨åˆ†ã€‚</p>
<p><strong>æ¢å¥è¯è¯´ï¼Œæ‰€æœ‰ç»„ä»¶éƒ½æ˜¯æœåŠ¡å™¨ç»„ä»¶ï¼Œé™¤éå®ƒä½¿ç”¨äº† <strong><code>&#39;use client&#39;</code></strong> æŒ‡ä»¤ï¼Œæˆ–è€…è¢«å¯¼å…¥åˆ° <strong><code>&#39;use client&#39;</code></strong> æ¨¡å—ä¸­ã€‚æ­¤æ—¶å®ƒä»¬ä¼šè¢«è§†ä¸ºå®¢æˆ·ç«¯ç»„ä»¶ã€‚è§†ä¸ºå®¢æˆ·ç«¯ç»„ä»¶ï¼Œå°±æ„å‘³ç€å®ƒçš„ä»£ç è¦è¢«æ‰“åŒ…åˆ°å®¢æˆ·ç«¯ bundle ä¸­ã€‚</strong></p>
<p>æ¯”å¦‚è¿™é‡Œçš„ <code>&lt;NotePreview&gt;</code>ï¼Œå®ƒè¢«å¯¼å…¥åˆ° <code>&lt;NoteEditor&gt;</code>è¿™ä¸ªå®¢æˆ·ç«¯ç»„ä»¶ä¸­ï¼Œå®ƒå°±å˜æˆäº†å®¢æˆ·ç«¯ç»„ä»¶ã€‚å˜æˆå®¢æˆ·ç«¯ç»„ä»¶ï¼Œæ„å‘³ç€ <code>&lt;NotePreview&gt;</code>ä¸­çš„ä»£ç ï¼ŒåŒ…æ‹¬ç”¨åˆ°çš„ <code>marked</code> å’Œ <code>sanitize-html</code>åº“ä¹Ÿè¦è¢«æ‰“åŒ…åˆ°å®¢æˆ·ç«¯ä¸­ï¼Œè¦çŸ¥é“ï¼Œè¿™ä¸¤ä¸ªåº“æ²¡å‹ç¼©å‰å¯æ˜¯æœ‰å‡ ç™¾ kB çš„ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬æ‰è¦å°†æœåŠ¡ç«¯ç»„ä»¶é€šè¿‡ props çš„å½¢å¼ä¼ ç»™å®¢æˆ·ç«¯ç»„ä»¶ï¼Œå½“é€šè¿‡è¿™ç§å½¢å¼çš„æ—¶å€™ï¼Œç»„ä»¶è¿˜æ˜¯æœåŠ¡ç«¯ç»„ä»¶ï¼Œä¼šåœ¨æœåŠ¡ç«¯æ‰§è¡Œæ¸²æŸ“ï¼Œä»£ç ä¹Ÿä¸ä¼šæ‰“åŒ…åˆ°å®¢æˆ·ç«¯ä¸­ã€‚å½“ç„¶åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°±æ˜¯éœ€è¦åœ¨å®¢æˆ·ç«¯æ¸²æŸ“ markdown æ–‡ä»¶ï¼Œæ‰€ä»¥ä»£ç å°±æ˜¯è¦æ‰“åŒ…åˆ°å®¢æˆ·ç«¯ä¸­çš„ï¼Œæ²¡æœ‰åŠæ³•é¿å…ã€‚</p>
<p>è®©æˆ‘ä»¬æŸ¥çœ‹ä¸‹ <code>http://localhost:3000/note/1702459188837</code>æ­¤æ—¶çš„æºä»£ç ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a35c49c3e80844a3b3d3dca0a75f04c3~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2864&h=1368&s=340452&e=png&b=fefefe" alt="æˆªå±2023-12-18 ä¸‹åˆ4.57.17.png"></p>
<p>é¢„è§ˆçš„æ—¶å€™ï¼Œæˆ‘ä»¬è™½ç„¶ç”¨äº† <code>&lt;NotePreview&gt;</code> è¿™ä¸ªç»„ä»¶ï¼Œä½†æ˜¯ä»£ç æ²¡æœ‰æ‰“åŒ…åˆ°å®¢æˆ·ç«¯ä¸­ã€‚ä½†æ˜¯å½“æˆ‘ä»¬æ‰“å¼€ <code>http://localhost:3000/note/edit/1702459188837</code>ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/34c359b68fcb40c191951848de16a26d~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2860&h=2028&s=434270&e=png&b=fefefe" alt="æˆªå±2023-12-18 ä¸‹åˆ4.58.35.png"></p>
<p>ä½ ä¼šå‘ç°ï¼Œä¸‹è½½äº†å®¢æˆ·ç«¯ç»„ä»¶ <code>&lt;NoteEditor&gt;</code> å’Œ <code>&lt;NotePreview&gt;</code>ï¼Œå¯¹åº”ä¹Ÿä½¿ç”¨äº†å¾ˆå¤šåº“ã€‚<code>page.js</code> ä¹Ÿå˜å¤§äº†å¾ˆå¤šï¼ˆ424 kBï¼‰ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9fa84b27070240afb30a1ae1f735fb0a~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=4174&h=1284&s=519073&e=png&b=fdfdfd" alt="æˆªå±2023-12-18 ä¸‹åˆ5.02.22.png"></p>
<p>æœ€åå†è¯´è¯´ä½¿ç”¨å®¢æˆ·ç«¯ç»„ä»¶æ—¶çš„ä¸€ä¸ªæ³¨æ„äº‹é¡¹ï¼Œé‚£å°±æ˜¯ä¸è¦ä½¿ç”¨ <code>async/await</code>ï¼Œå¯èƒ½ä¼šå‡ºç°æŠ¥é”™ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2aec6fbc3415411681f4b8dd184bc557~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1912&h=180&s=53835&e=png&b=ffffff" alt="image.png"></p>
<h2>ç¬”è®°ç¼–è¾‘å’Œåˆ é™¤</h2>
<p>å½“ç‚¹å‡» <code>Done</code> çš„æ—¶å€™ï¼Œå¯¼èˆªè‡³å¯¹åº”çš„ç¬”è®°é¢„è§ˆé¡µé¢ <code>/note/xxxx</code>ã€‚å½“ç‚¹å‡» <code>Delete</code> çš„æ—¶å€™ï¼Œå¯¼èˆªè‡³é¦–é¡µã€‚</p>
<p>æ­£å¸¸å¼€å‘ç¬”è®°çš„å¢åŠ ã€æ›´æ–°å’Œåˆ é™¤åŠŸèƒ½ï¼Œä¸ºäº†å®ç°å‰åç«¯äº¤äº’ï¼Œå¯èƒ½è¦å†™å¤šä¸ªæ¥å£æ¥å®ç°ï¼Œæ¯”å¦‚å½“ç‚¹å‡»åˆ é™¤çš„æ—¶å€™ï¼Œè°ƒç”¨åˆ é™¤æ¥å£ï¼Œæ¥å£è¿”å›æˆåŠŸï¼Œå‰ç«¯è·³è½¬è‡³é¦–é¡µã€‚ä½†æ—¢ç„¶æˆ‘ä»¬éƒ½ç”¨äº† Next.js 14 äº†ï¼Œæ²¡å¿…è¦è¿™ä¹ˆéº»çƒ¦ï¼ŒServer Actions ç›´æ¥æå®šï¼Œçœçš„ä¸€ä¸ªä¸ªå†™æ¥å£äº†ã€‚</p>
<p>ä¿®æ”¹ <code>/components/NoteEditor.js</code> ä»£ç ï¼š</p>
<pre><code class="language-javascript">&#39;use client&#39;

// ...
import { deleteNote, saveNote } from &#39;../app/actions&#39;

export default function NoteEditor({
  noteId,
  initialTitle,
  initialBody
}) {
	//...
  return (
    &lt;div className=&quot;note-editor&quot;&gt;
    	// ...
      &lt;div className=&quot;note-editor-preview&quot;&gt;
        &lt;form className=&quot;note-editor-menu&quot; role=&quot;menubar&quot;&gt;
          &lt;button
            className=&quot;note-editor-done&quot;
            disabled={pending}
            type=&quot;submit&quot;
            formAction={() =&gt; saveNote(noteId, title, body)}
            role=&quot;menuitem&quot;
          &gt;
            // ...
            Done
          &lt;/button&gt;
          {!isDraft &amp;&amp; (
            &lt;button
              className=&quot;note-editor-delete&quot;
              disabled={pending}
              formAction={() =&gt; deleteNote(noteId)}
              role=&quot;menuitem&quot;
            &gt;
              // ...
              Delete
            &lt;/button&gt;
          )}
        &lt;/form&gt;
      	// ...
      &lt;/div&gt;
    &lt;/div&gt;
  )
}
</code></pre>
<p>å…¶ä¸­æœ€ä¸ºæ ¸å¿ƒçš„ä»£ç å°±æ˜¯ï¼š</p>
<pre><code class="language-html">&lt;form className=&quot;note-editor-menu&quot; role=&quot;menubar&quot;&gt;
  &lt;button formAction={() =&gt; saveNote(noteId, title, body)}&gt;
    Done
  &lt;/button&gt;
  &lt;button formAction={() =&gt; deleteNote(noteId)} &gt;
    Delete
  &lt;/button&gt;
&lt;/form&gt;
</code></pre>
<p><code>app/actions.js</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">&#39;use server&#39;

import { redirect } from &#39;next/navigation&#39;
import {addNote, updateNote, delNote} from &#39;@/lib/redis&#39;;

export async function saveNote(noteId, title, body) {
  
  const data = JSON.stringify({
    title,
    content: body,
    updateTime: new Date()
  })

  if (noteId) {
    updateNote(noteId, data)
    redirect(`/note/${noteId}`)
  } else {
    const res = await addNote(data)
    redirect(`/note/${res}`)
  }

}

export async function deleteNote(noteId) {
  delNote(noteId)
  redirect(&#39;/&#39;)
}
</code></pre>
<p>æ­¤æ—¶æ–°å¢å’Œåˆ é™¤çœ‹ä¼¼å¯ä»¥â€œæ­£å¸¸è¿è¡Œâ€äº†ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9a0645420e6d4a6884a5c07d5ea19d1e~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1158&h=727&s=114474&e=gif&f=33&b=f3f5f9" alt="æ·»åŠ æ–‡ç« .gif"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f1959b1e863248a9b121ff5f6d8acc0c~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1158&h=727&s=101093&e=gif&f=29&b=fefefe" alt="åˆ é™¤æ–‡ç« .gif"></p>
<p>æ³¨ï¼šå†™è¿™ä¸ª demo çš„æ—¶å€™å¯èƒ½ä¼šé‡åˆ°ç‚¹äº†æŒ‰é’®æ²¡æœ‰ååº”ï¼Œå¡é¡¿ 5s çš„æƒ…å†µï¼Œè¿™æ˜¯å› ä¸ºä¹‹å‰çš„ demo é‡Œæˆ‘ä»¬æœ‰åœ¨å¤šä¸ªç»„ä»¶é‡Œå†™ sleep 5sï¼Œåˆ é™¤ç›¸åº”çš„ä»£ç å³å¯ã€‚</p>
<h2>Server Actions</h2>
<p>å€ŸåŠ© Server Actionsï¼Œæˆ‘ä»¬å¾ˆç®€å•çš„å°±å®ç°äº†ç¬”è®°çš„æ–°å¢å’Œåˆ é™¤æ•ˆæœï¼Œä½†å…¶å®ç›®å‰çš„ä»£ç ä¸­è¿˜æœ‰å¾ˆå¤šé—®é¢˜ã€‚</p>
<h3>1. å®Œæ•´è·¯ç”±ç¼“å­˜ä¸ revalidate</h3>
<p>æ¯”å¦‚å½“æˆ‘ä»¬è¿ç»­ 2 æ¬¡æ–°å¢ç¬”è®°æ—¶ï¼Œè§‚å¯Ÿå·¦ä¾§çš„ç¬”è®°åˆ—è¡¨å˜åŒ–ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87f86356225d48e7ae87830cb8189542~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1217&h=679&s=302944&e=gif&f=75&b=f3f5f9" alt="å¤šæ¬¡æ–°å¢å‡ºç°é—®é¢˜.gif"></p>
<p>ç¬”è®°åˆ—è¡¨åˆå§‹æœ‰ 3 æ¡ï¼Œæ–°å¢ç¬¬ 1 æ¡ç¬”è®°åï¼Œå·¦ä¾§çš„ç¬”è®°åˆ—è¡¨æ˜¾ç¤º 4 æ¡ï¼Œä½†å½“æˆ‘ä»¬æ–°å¢ç¬¬ 2 æ¡ç¬”è®°çš„æ—¶å€™ï¼Œå·¦ä¾§çš„ç¬”è®°åˆ—è¡¨åˆå˜æˆäº† 3 æ¡ï¼Œæ–°å¢ç¬¬ 2 æ¡ç¬”è®°åï¼Œå·¦ä¾§çš„ç¬”è®°åˆ—è¡¨æ˜¾ç¤º 5 æ¡ã€‚</p>
<p>å¦‚æœä½ å¯¼èˆªè‡³é¦–é¡µ <code>/</code>ï¼Œä½ ä¼šå‘ç°è¿˜æ˜¯ 3 æ¡ï¼Œè€Œä¸”å“ªæ€•ä½ æ¸…ç©ºç¼“å­˜å¹¶ç¡¬æ€§é‡æ–°åŠ è½½ï¼Œè¿˜æ˜¯ 3 æ¡ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>è¿™å°±æ˜¯<a href="https://juejin.cn/book/7307859898316881957/section/7309077169735958565#heading-13">å®Œæ•´è·¯ç”±ç¼“å­˜</a>ã€‚ä»¥ <code>/note/edit</code>ä¸ºä¾‹ï¼Œè·¯ç”±é»˜è®¤æ˜¯é™æ€æ¸²æŸ“ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¼šåœ¨æ„å»ºçš„æ—¶å€™ï¼Œè¯»å–æ•°æ®ï¼Œç„¶åå°†ç¼–è¯‘åçš„ HTML å’Œ RSC Payload ç¼“å­˜ï¼Œæ„å»ºçš„æ—¶å€™ï¼Œæ•°æ®åº“é‡Œæœ‰ 3 æ¡æ•°æ®ï¼Œæ‰€ä»¥ HTML ä¸­ä¹Ÿåªæœ‰ 3 æ¡æ•°æ®ï¼Œæ‰€ä»¥åç»­æ‰“å¼€ <code>/note/edit</code>ä¹Ÿéƒ½æ˜¯ 3 æ¡æ•°æ®ã€‚</p>
<p>è¿˜è®°å¾—å¦‚ä½•è®©å®Œæ•´è·¯ç”±ç¼“å­˜å¤±æ•ˆå—ï¼Ÿ</p>
<blockquote>
<p>æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥ä½¿å®Œæ•´è·¯ç”±ç¼“å­˜å¤±æ•ˆï¼š</p>
<ul>
<li>é‡æ–°éªŒè¯æ•°æ®ï¼šé‡æ–°éªŒè¯æ•°æ®ç¼“å­˜å°†ä½¿å®Œæ•´è·¯ç”±ç¼“å­˜å¤±æ•ˆï¼Œæ¯•ç«Ÿæ¸²æŸ“è¾“å‡ºä¾èµ–äºæ•°æ®</li>
<li>é‡æ–°éƒ¨ç½²ï¼šæ•°æ®ç¼“å­˜æ˜¯å¯ä»¥è·¨éƒ¨ç½²çš„ï¼Œä½†å®Œæ•´è·¯ç”±ç¼“å­˜ä¼šåœ¨é‡æ–°éƒ¨ç½²ä¸­è¢«æ¸…é™¤</li>
</ul>
</blockquote>
<p>æ­¤å¤–ï¼Œå®¢æˆ·ç«¯è·¯ç”±ç¼“å­˜çš„å¤±æ•ˆä¹Ÿéœ€è¦å€ŸåŠ© revalidateï¼š</p>
<blockquote>
<p>æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è®©è·¯ç”±ç¼“å­˜å¤±æ•ˆï¼š</p>
<ul>
<li>åœ¨ Server Action ä¸­ï¼š<ul>
<li>é€šè¿‡ <code>revalidatePath</code> æˆ– <code>revalidateTag</code> é‡æ–°éªŒè¯æ•°æ®</li>
<li>ä½¿ç”¨ <code>cookies.set</code> æˆ–è€… <code>cookies.delete</code> ä¼šä½¿è·¯ç”±ç¼“å­˜å¤±æ•ˆ</li>
</ul>
</li>
<li>è°ƒç”¨ <code>router.refresh</code> ä¼šä½¿è·¯ç”±ç¼“å­˜å¤±æ•ˆå¹¶å‘èµ·ä¸€ä¸ªé‡æ–°è·å–å½“å‰è·¯ç”±çš„è¯·æ±‚</li>
</ul>
</blockquote>
<p>æ‰€ä»¥åœ¨è¿›è¡Œæ•°æ®å¤„ç†çš„æ—¶å€™ï¼Œä¸€å®šè¦è®°å¾—é‡æ–°éªŒè¯æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ <a href="https://juejin.cn/book/7307859898316881957/section/7309079586296791050#heading-12">revalidatePath</a> å’Œ <a href="https://juejin.cn/book/7307859898316881957/section/7309079586296791050#heading-23">revalidateTag</a>ã€‚ç°åœ¨æˆ‘ä»¬ä¿®æ”¹ä¸‹ <code>app/actions.js</code>ï¼š</p>
<pre><code class="language-javascript">&#39;use server&#39;

import { redirect } from &#39;next/navigation&#39;
import {addNote, updateNote, delNote} from &#39;@/lib/redis&#39;;
import { revalidatePath } from &#39;next/cache&#39;;

export async function saveNote(noteId, title, body) {
  
  const data = JSON.stringify({
    title,
    content: body,
    updateTime: new Date()
  })

  if (noteId) {
    updateNote(noteId, data)
    revalidatePath(&#39;/&#39;, &#39;layout&#39;)
    redirect(`/note/${noteId}`)
  } else {
    const res = await addNote(data)
    revalidatePath(&#39;/&#39;, &#39;layout&#39;)
    redirect(`/note/${res}`)
  }

}

export async function deleteNote(noteId) {
  delNote(noteId)
  revalidatePath(&#39;/&#39;, &#39;layout&#39;)
  redirect(&#39;/&#39;)
}
</code></pre>
<p>è¿™é‡Œæˆ‘ä»¬ç®€å•ç²—æš´äº†æ¸…é™¤äº†æ‰€æœ‰ç¼“å­˜ï¼Œæ­¤æ—¶æ–°å¢ã€ç¼–è¾‘ã€åˆ é™¤åº”è¯¥éƒ½è¿è¡Œæ­£å¸¸äº†ã€‚</p>
<h3>2. å®ç°åŸç†</h3>
<p>ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹å½“æˆ‘ä»¬ç‚¹å‡» <code>Done</code> æŒ‰é’®çš„æ—¶å€™åšäº†ä»€ä¹ˆï¼Ÿ</p>
<p>æˆ‘ä»¬å…ˆæ³¨é‡Šæ‰ <code>actions.js</code> ä¸­çš„ <code>redirect</code>ï¼Œè¿™æ ·å½“æ›´æ–°ç¬”è®°çš„æ—¶å€™ï¼Œä¸ä¼šå‘ç”Ÿé‡å®šå‘ã€‚ç„¶åæˆ‘ä»¬ç¼–è¾‘ä¸€æ¡ç¬”è®°ï¼Œç„¶åç‚¹å‡» <code>Done</code>ï¼Œå¯ä»¥çœ‹åˆ°é¡µé¢å‘é€äº†ä¸€æ¡ POST è¯·æ±‚ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c90b64cab4574e039d0217f8dd00698d~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=996&h=216&s=33127&e=png&b=1a1a1c" alt="image.png"></p>
<p>è¯·æ±‚åœ°å€æ˜¯å½“å‰é¡µé¢ï¼Œè¯·æ±‚æ–¹æ³•ä¸º POSTã€‚è¯·æ±‚å†…å®¹æ­£æ˜¯æˆ‘ä»¬ä¼ å…¥çš„å†…å®¹ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fdff7b54fd374276a4506430c77bf71b~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1094&h=284&s=46305&e=png&b=1a1a1c" alt="image.png"></p>
<p>å“åº”å†…å®¹ä¸ºï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c5a0c3bc78974f4d9528281d39d66927~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=844&h=210&s=35811&e=png&b=19191b" alt="image.png"></p>
<p>å¦‚æœæˆ‘ä»¬ä¸æ³¨é‡Šæ‰ <code>actions.js</code> ä¸­çš„ <code>redirect</code>ï¼Œç„¶åæˆ‘ä»¬ç¼–è¾‘ä¸€æ¡ç¬”è®°ï¼Œç„¶åç‚¹å‡» <code>Done</code>ï¼Œå¯ä»¥çœ‹åˆ°é¡µé¢å‘é€äº†ä¸€æ¡ POST è¯·æ±‚ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0295a63c46c046988f6b5d7cc0c53249~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=908&h=218&s=32790&e=png&b=19191b" alt="image.png"></p>
<p>å› ä¸ºæœ‰é‡å®šå‘ï¼Œæ‰€ä»¥è¯·æ±‚çŠ¶æ€å˜æˆäº† 303ã€‚å“åº”å†…å®¹ä¸ºï¼š</p>
<pre><code class="language-javascript">3:I[5613,[],&quot;&quot;]
5:I[1778,[],&quot;&quot;]
4:[&quot;id&quot;,&quot;1702459182837&quot;,&quot;d&quot;]
0:[&quot;SN0qCiPbAaKKSAlQfIuYC&quot;,[[[&quot;&quot;,{&quot;children&quot;:[&quot;note&quot;,{&quot;children&quot;:[[&quot;id&quot;,&quot;1702459182837&quot;,&quot;d&quot;],{&quot;children&quot;:[&quot;__PAGE__&quot;,{}]}]}]},&quot;$undefined&quot;,&quot;$undefined&quot;,true],[&quot;&quot;,{&quot;children&quot;:[&quot;note&quot;,{&quot;children&quot;:[[&quot;id&quot;,&quot;1702459182837&quot;,&quot;d&quot;],{&quot;children&quot;:[&quot;__PAGE__&quot;,{},[&quot;$L1&quot;,&quot;$L2&quot;,null]]},[&quot;$&quot;,&quot;$L3&quot;,null,{&quot;parallelRouterKey&quot;:&quot;children&quot;,&quot;segmentPath&quot;:[&quot;children&quot;,&quot;note&quot;,&quot;children&quot;,&quot;$4&quot;,&quot;children&quot;],&quot;loading&quot;:[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;note skeleton-container&quot;,&quot;role&quot;:&quot;progressbar&quot;,&quot;aria-busy&quot;:&quot;true&quot;,&quot;children&quot;:[[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;note-header&quot;,&quot;children&quot;:[[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;note-title skeleton&quot;,&quot;style&quot;:{&quot;height&quot;:&quot;3rem&quot;,&quot;width&quot;:&quot;65%&quot;,&quot;marginInline&quot;:&quot;12px 1em&quot;}}],[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;skeleton skeleton--button&quot;,&quot;style&quot;:{&quot;width&quot;:&quot;8em&quot;,&quot;height&quot;:&quot;2.5em&quot;}}]]}],[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;note-preview&quot;,&quot;children&quot;:[[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;skeleton v-stack&quot;,&quot;style&quot;:{&quot;height&quot;:&quot;1.5em&quot;}}],[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;skeleton v-stack&quot;,&quot;style&quot;:{&quot;height&quot;:&quot;1.5em&quot;}}],[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;skeleton v-stack&quot;,&quot;style&quot;:{&quot;height&quot;:&quot;1.5em&quot;}}],[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;skeleton v-stack&quot;,&quot;style&quot;:{&quot;height&quot;:&quot;1.5em&quot;}}],[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;skeleton v-stack&quot;,&quot;style&quot;:{&quot;height&quot;:&quot;1.5em&quot;}}]]}]]}],&quot;loadingStyles&quot;:[],&quot;loadingScripts&quot;:[],&quot;hasLoading&quot;:true,&quot;error&quot;:&quot;$undefined&quot;,&quot;errorStyles&quot;:&quot;$undefined&quot;,&quot;errorScripts&quot;:&quot;$undefined&quot;,&quot;template&quot;:[&quot;$&quot;,&quot;$L5&quot;,null,{}],&quot;templateStyles&quot;:&quot;$undefined&quot;,&quot;templateScripts&quot;:&quot;$undefined&quot;,&quot;notFound&quot;:&quot;$undefined&quot;,&quot;notFoundStyles&quot;:&quot;$undefined&quot;,&quot;styles&quot;:null}]]},[&quot;$&quot;,&quot;$L3&quot;,null,{&quot;parallelRouterKey&quot;:&quot;children&quot;,&quot;segmentPath&quot;:[&quot;children&quot;,&quot;note&quot;,&quot;children&quot;],&quot;loading&quot;:&quot;$undefined&quot;,&quot;loadingStyles&quot;:&quot;$undefined&quot;,&quot;loadingScripts&quot;:&quot;$undefined&quot;,&quot;hasLoading&quot;:false,&quot;error&quot;:&quot;$undefined&quot;,&quot;errorStyles&quot;:&quot;$undefined&quot;,&quot;errorScripts&quot;:&quot;$undefined&quot;,&quot;template&quot;:[&quot;$&quot;,&quot;$L5&quot;,null,{}],&quot;templateStyles&quot;:&quot;$undefined&quot;,&quot;templateScripts&quot;:&quot;$undefined&quot;,&quot;notFound&quot;:&quot;$undefined&quot;,&quot;notFoundStyles&quot;:&quot;$undefined&quot;,&quot;styles&quot;:null}]]},[null,&quot;$L6&quot;,null]],[[[&quot;$&quot;,&quot;link&quot;,&quot;0&quot;,{&quot;rel&quot;:&quot;stylesheet&quot;,&quot;href&quot;:&quot;/_next/static/css/10169c963ccea784.css&quot;,&quot;precedence&quot;:&quot;next&quot;,&quot;crossOrigin&quot;:&quot;$undefined&quot;}]],&quot;$L7&quot;]]]]
9:I[5250,[&quot;250&quot;,&quot;static/chunks/250-3c648b94097e3c7b.js&quot;,&quot;156&quot;,&quot;static/chunks/app/note/%5Bid%5D/page-5070a024863ac55b.js&quot;],&quot;&quot;]
6:[&quot;$&quot;,&quot;html&quot;,null,{&quot;lang&quot;:&quot;en&quot;,&quot;children&quot;:[&quot;$&quot;,&quot;body&quot;,null,{&quot;children&quot;:[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;container&quot;,&quot;children&quot;:[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;main&quot;,&quot;children&quot;:[&quot;$L8&quot;,[&quot;$&quot;,&quot;section&quot;,null,{&quot;className&quot;:&quot;col note-viewer&quot;,&quot;children&quot;:[&quot;$&quot;,&quot;$L3&quot;,null,{&quot;parallelRouterKey&quot;:&quot;children&quot;,&quot;segmentPath&quot;:[&quot;children&quot;],&quot;loading&quot;:&quot;$undefined&quot;,&quot;loadingStyles&quot;:&quot;$undefined&quot;,&quot;loadingScripts&quot;:&quot;$undefined&quot;,&quot;hasLoading&quot;:false,&quot;error&quot;:&quot;$undefined&quot;,&quot;errorStyles&quot;:&quot;$undefined&quot;,&quot;errorScripts&quot;:&quot;$undefined&quot;,&quot;template&quot;:[&quot;$&quot;,&quot;$L5&quot;,null,{}],&quot;templateStyles&quot;:&quot;$undefined&quot;,&quot;templateScripts&quot;:&quot;$undefined&quot;,&quot;notFound&quot;:[[&quot;$&quot;,&quot;title&quot;,null,{&quot;children&quot;:&quot;404: This page could not be found.&quot;}],[&quot;$&quot;,&quot;div&quot;,null,{&quot;style&quot;:{&quot;fontFamily&quot;:&quot;system-ui,\&quot;Segoe UI\&quot;,Roboto,Helvetica,Arial,sans-serif,\&quot;Apple Color Emoji\&quot;,\&quot;Segoe UI Emoji\&quot;&quot;,&quot;height&quot;:&quot;100vh&quot;,&quot;textAlign&quot;:&quot;center&quot;,&quot;display&quot;:&quot;flex&quot;,&quot;flexDirection&quot;:&quot;column&quot;,&quot;alignItems&quot;:&quot;center&quot;,&quot;justifyContent&quot;:&quot;center&quot;},&quot;children&quot;:[&quot;$&quot;,&quot;div&quot;,null,{&quot;children&quot;:[[&quot;$&quot;,&quot;style&quot;,null,{&quot;dangerouslySetInnerHTML&quot;:{&quot;__html&quot;:&quot;body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}&quot;}}],[&quot;$&quot;,&quot;h1&quot;,null,{&quot;className&quot;:&quot;next-error-h1&quot;,&quot;style&quot;:{&quot;display&quot;:&quot;inline-block&quot;,&quot;margin&quot;:&quot;0 20px 0 0&quot;,&quot;padding&quot;:&quot;0 23px 0 0&quot;,&quot;fontSize&quot;:24,&quot;fontWeight&quot;:500,&quot;verticalAlign&quot;:&quot;top&quot;,&quot;lineHeight&quot;:&quot;49px&quot;},&quot;children&quot;:&quot;404&quot;}],[&quot;$&quot;,&quot;div&quot;,null,{&quot;style&quot;:{&quot;display&quot;:&quot;inline-block&quot;},&quot;children&quot;:[&quot;$&quot;,&quot;h2&quot;,null,{&quot;style&quot;:{&quot;fontSize&quot;:14,&quot;fontWeight&quot;:400,&quot;lineHeight&quot;:&quot;49px&quot;,&quot;margin&quot;:0},&quot;children&quot;:&quot;This page could not be found.&quot;}]}]]}]}]],&quot;notFoundStyles&quot;:[],&quot;styles&quot;:null}]}]]}]}]}]}]
7:[[&quot;$&quot;,&quot;meta&quot;,&quot;0&quot;,{&quot;name&quot;:&quot;viewport&quot;,&quot;content&quot;:&quot;width=device-width, initial-scale=1&quot;}],[&quot;$&quot;,&quot;meta&quot;,&quot;1&quot;,{&quot;charSet&quot;:&quot;utf-8&quot;}],[&quot;$&quot;,&quot;link&quot;,&quot;2&quot;,{&quot;rel&quot;:&quot;icon&quot;,&quot;href&quot;:&quot;/favicon.ico&quot;,&quot;type&quot;:&quot;image/x-icon&quot;,&quot;sizes&quot;:&quot;16x16&quot;}]]
1:null
2:[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;note&quot;,&quot;children&quot;:[[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;note-header&quot;,&quot;children&quot;:[[&quot;$&quot;,&quot;h1&quot;,null,{&quot;className&quot;:&quot;note-title&quot;,&quot;children&quot;:&quot;3qui est&quot;}],[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;note-menu&quot;,&quot;role&quot;:&quot;menubar&quot;,&quot;children&quot;:[[&quot;$&quot;,&quot;small&quot;,null,{&quot;className&quot;:&quot;note-updated-at&quot;,&quot;role&quot;:&quot;status&quot;,&quot;children&quot;:[&quot;Last updated on &quot;,&quot;2023-12-19 05:33:09&quot;]}],[&quot;$&quot;,&quot;$L9&quot;,null,{&quot;href&quot;:&quot;/note/edit/1702459182837&quot;,&quot;className&quot;:&quot;link--unstyled&quot;,&quot;children&quot;:[&quot;$&quot;,&quot;button&quot;,null,{&quot;className&quot;:&quot;edit-button edit-button--outline&quot;,&quot;role&quot;:&quot;menuitem&quot;,&quot;children&quot;:&quot;Edit&quot;}]}]]}]]}],[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;note-preview&quot;,&quot;children&quot;:[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;text-with-markdown&quot;,&quot;dangerouslySetInnerHTML&quot;:{&quot;__html&quot;:&quot;&lt;p&gt;est rerum tempore vitae sequi sint&lt;/p&gt;\n&quot;}}]}]]}]
a:&quot;$Sreact.suspense&quot;
8:[&quot;$&quot;,&quot;section&quot;,null,{&quot;className&quot;:&quot;col sidebar&quot;,&quot;children&quot;:[[&quot;$&quot;,&quot;$L9&quot;,null,{&quot;href&quot;:&quot;/&quot;,&quot;className&quot;:&quot;link--unstyled&quot;,&quot;children&quot;:[&quot;$&quot;,&quot;section&quot;,null,{&quot;className&quot;:&quot;sidebar-header&quot;,&quot;children&quot;:[[&quot;$&quot;,&quot;img&quot;,null,{&quot;className&quot;:&quot;logo&quot;,&quot;src&quot;:&quot;/logo.svg&quot;,&quot;width&quot;:&quot;22px&quot;,&quot;height&quot;:&quot;20px&quot;,&quot;alt&quot;:&quot;&quot;,&quot;role&quot;:&quot;presentation&quot;}],[&quot;$&quot;,&quot;strong&quot;,null,{&quot;children&quot;:&quot;React Notes&quot;}]]}]}],[&quot;$&quot;,&quot;section&quot;,null,{&quot;className&quot;:&quot;sidebar-menu&quot;,&quot;role&quot;:&quot;menubar&quot;,&quot;children&quot;:[&quot;$&quot;,&quot;$L9&quot;,null,{&quot;href&quot;:&quot;/note/edit/&quot;,&quot;className&quot;:&quot;link--unstyled&quot;,&quot;children&quot;:[&quot;$&quot;,&quot;button&quot;,null,{&quot;className&quot;:&quot;edit-button edit-button--solid&quot;,&quot;role&quot;:&quot;menuitem&quot;,&quot;children&quot;:&quot;New&quot;}]}]}],[&quot;$&quot;,&quot;nav&quot;,null,{&quot;children&quot;:[&quot;$&quot;,&quot;$a&quot;,null,{&quot;fallback&quot;:[&quot;$&quot;,&quot;div&quot;,null,{&quot;children&quot;:[&quot;$&quot;,&quot;ul&quot;,null,{&quot;className&quot;:&quot;notes-list skeleton-container&quot;,&quot;children&quot;:[[&quot;$&quot;,&quot;li&quot;,null,{&quot;className&quot;:&quot;v-stack&quot;,&quot;children&quot;:[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;sidebar-note-list-item skeleton&quot;,&quot;style&quot;:{&quot;height&quot;:&quot;5em&quot;}}]}],[&quot;$&quot;,&quot;li&quot;,null,{&quot;className&quot;:&quot;v-stack&quot;,&quot;children&quot;:[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;sidebar-note-list-item skeleton&quot;,&quot;style&quot;:{&quot;height&quot;:&quot;5em&quot;}}]}],[&quot;$&quot;,&quot;li&quot;,null,{&quot;className&quot;:&quot;v-stack&quot;,&quot;children&quot;:[&quot;$&quot;,&quot;div&quot;,null,{&quot;className&quot;:&quot;sidebar-note-list-item skeleton&quot;,&quot;style&quot;:{&quot;height&quot;:&quot;5em&quot;}}]}]]}]}],&quot;children&quot;:&quot;$Lb&quot;}]}]]}]
c:I[610,[&quot;250&quot;,&quot;static/chunks/250-3c648b94097e3c7b.js&quot;,&quot;185&quot;,&quot;static/chunks/app/layout-7bae744084688543.js&quot;],&quot;&quot;]
b:[&quot;$&quot;,&quot;ul&quot;,null,{&quot;className&quot;:&quot;notes-list&quot;,&quot;children&quot;:[[&quot;$&quot;,&quot;li&quot;,&quot;1702459182837&quot;,{&quot;children&quot;:[&quot;$&quot;,&quot;$Lc&quot;,null,{&quot;id&quot;:&quot;1702459182837&quot;,&quot;title&quot;:&quot;3qui est&quot;,&quot;expandedChildren&quot;:[&quot;$&quot;,&quot;p&quot;,null,{&quot;className&quot;:&quot;sidebar-note-excerpt&quot;,&quot;children&quot;:&quot;est rerum tempore vi&quot;}],&quot;children&quot;:[&quot;$&quot;,&quot;header&quot;,null,{&quot;className&quot;:&quot;sidebar-note-header&quot;,&quot;children&quot;:[[&quot;$&quot;,&quot;strong&quot;,null,{&quot;children&quot;:&quot;3qui est&quot;}],[&quot;$&quot;,&quot;small&quot;,null,{&quot;children&quot;:&quot;2023-12-19 05:33:09&quot;}]]}]}]}],[&quot;$&quot;,&quot;li&quot;,&quot;1702459181837&quot;,{&quot;children&quot;:[&quot;$&quot;,&quot;$Lc&quot;,null,{&quot;id&quot;:&quot;1702459181837&quot;,&quot;title&quot;:&quot;sunt aut&quot;,&quot;expandedChildren&quot;:[&quot;$&quot;,&quot;p&quot;,null,{&quot;className&quot;:&quot;sidebar-note-excerpt&quot;,&quot;children&quot;:&quot;quia et suscipit sus&quot;}],&quot;children&quot;:[&quot;$&quot;,&quot;header&quot;,null,{&quot;className&quot;:&quot;sidebar-note-header&quot;,&quot;children&quot;:[[&quot;$&quot;,&quot;strong&quot;,null,{&quot;children&quot;:&quot;sunt aut&quot;}],[&quot;$&quot;,&quot;small&quot;,null,{&quot;children&quot;:&quot;2023-12-13 05:19:48&quot;}]]}]}]}],[&quot;$&quot;,&quot;li&quot;,&quot;1702459188837&quot;,{&quot;children&quot;:[&quot;$&quot;,&quot;$Lc&quot;,null,{&quot;id&quot;:&quot;1702459188837&quot;,&quot;title&quot;:&quot;ea molestias&quot;,&quot;expandedChildren&quot;:[&quot;$&quot;,&quot;p&quot;,null,{&quot;className&quot;:&quot;sidebar-note-excerpt&quot;,&quot;children&quot;:&quot;et iusto sed quo iur&quot;}],&quot;children&quot;:[&quot;$&quot;,&quot;header&quot;,null,{&quot;className&quot;:&quot;sidebar-note-header&quot;,&quot;children&quot;:[[&quot;$&quot;,&quot;strong&quot;,null,{&quot;children&quot;:&quot;ea molestias&quot;}],[&quot;$&quot;,&quot;small&quot;,null,{&quot;children&quot;:&quot;2023-12-13 05:19:48&quot;}]]}]}]}]]}]
</code></pre>
<p>æ­¤æ—¶é‡å®šå‘åœ°å€ä¸º <code>/note/1702459182837</code>ï¼Œä»å“åº”çš„å†…å®¹ä¸­å¯ä»¥çœ‹å‡ºï¼Œå…¶ä¸­åŒ…å«äº†æ¸²æŸ“åçš„ç¬”è®°åˆ—è¡¨å’Œæ­¤æ¡ç¬”è®°çš„å…·ä½“å†…å®¹ã€‚è¯¥å†…å®¹ä¹Ÿæ˜¯æµå¼åŠ è½½çš„ï¼Œæ‰€ä»¥å†…å®¹ä¼šé€æ­¥æ¸²æŸ“å‡ºæ¥ã€‚æ¯”å¦‚æˆ‘ä»¬æŠŠ  <code>/note/[id]/page.js</code>çš„ <code>sleep</code> è®¾ç½®ä¸º 10sï¼Œ<code>/components/SidebarNoteList.js</code>çš„ sleep è®¾ç½®ä¸º 3sï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/32e9a1987dc542a3a3fe1fe6f1e8a2c6~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1273&h=673&s=227282&e=gif&f=68&b=fefefe" alt="ReactNotesæ›´æ–°æµå¼æ¸²æŸ“.gif"></p>
<p>ç‚¹å‡»åï¼Œå·¦ä¾§ç¬”è®°åˆ—è¡¨ 3s åå‘ç”Ÿäº†å˜åŒ–ï¼Œå³ä¾§ç¬”è®°é¢„è§ˆ 10s åå‘ç”Ÿäº†å˜åŒ–ã€‚</p>
<p>æ‰€ä»¥å½“æäº¤è¡¨å•çš„æ—¶å€™å‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®å°±æ˜¯å°†æ•°æ®ä»¥ POST è¯·æ±‚æäº¤ç»™å½“å‰é¡µé¢ï¼ŒæœåŠ¡ç«¯æ ¹æ® Server Actions ä¸­çš„å®šä¹‰è¿›è¡Œå¤„ç†ã€‚Next.js æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿå…¶å®å°±ç›¸å½“äºæ›¿ä½ å†™äº†åŸæœ¬ç”¨äºäº¤äº’çš„æ¥å£ã€‚</p>
<h3>3. æ¸è¿›å¼å¢å¼º</h3>
<p>ä½¿ç”¨ Server Actions çš„ä¸€å¤§å¥½å¤„å°±æ˜¯æ¸è¿›å¼å¢å¼ºï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä¾¿ä½ ç¦ç”¨äº† JavaScriptï¼Œç…§æ ·å¯ä»¥ç”Ÿæ•ˆã€‚ç°åœ¨è®©æˆ‘ä»¬æŸ¥çœ‹ <code>Done</code>å’Œ <code>Delete</code>æŒ‰é’®çš„æºç ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a7499d601a5b4c0a9a0da2f9dfcfceaf~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2740&h=596&s=305438&e=png&b=272727" alt="image.png"></p>
<p>æŒ‰é’®çš„ <code>formaction</code> å±æ€§å˜æˆäº†ï¼š</p>
<blockquote>
<p>javascript:throw new Error(&#39;A React form was unexpectedly submitted. If you called form.submit() manually, consider using form.requestSubmit() instead. If you&#39;re trying to use event.stopPropagation() in a submit event handler, consider also calling event.preventDefault().&#39;)&quot;</p>
</blockquote>
<p>è¿™è¯´æ˜â€¦â€¦ä»£ç å†™çš„æœ‰é—®é¢˜â€¦â€¦</p>
<p>ç°åœ¨æˆ‘ä»¬æäº¤è¡¨å•çš„ä»£ç ä¸ºï¼š</p>
<pre><code class="language-html">&lt;form className=&quot;note-editor-menu&quot; role=&quot;menubar&quot;&gt;
  &lt;button formAction={() =&gt; saveNote(noteId, title, body)}&gt;
    Done
  &lt;/button&gt;
&lt;/form&gt;
</code></pre>
<p>è™½ç„¶è¿™ç§å†™æ³•ä¹Ÿå¯ä»¥ç”Ÿæ•ˆï¼Œä½†åœ¨ç¦ç”¨ JavaScript çš„æ—¶å€™ä¼šå¤±æ•ˆï¼Œä¸ºäº†é¿å…è¿™ä¸ªé”™è¯¯ï¼Œæœ€å¥½æ˜¯åƒä¸‹é¢è¿™æ ·å†™ï¼š</p>
<pre><code class="language-html">&lt;form className=&quot;note-editor-menu&quot; role=&quot;menubar&quot;&gt;
  &lt;button formAction={saveNote}&gt;
    Done
  &lt;/button&gt;
&lt;/form&gt;
</code></pre>
<p>é‚£ä¹ˆ noteId è¯¥å¦‚ä½•ä¼ å…¥å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¼ ç»Ÿçš„éšè— inputï¼š</p>
<pre><code class="language-html">&lt;input type=&quot;hidden&quot; name=&quot;noteId&quot; value={noteId} /&gt;
</code></pre>
<p>ç°åœ¨è®©æˆ‘ä»¬é‡æ–°å†™ä¸‹ <code>components/NoteEditor.js</code> çš„ä»£ç ï¼š</p>
<pre><code class="language-jsx">&#39;use client&#39;

import { useState } from &#39;react&#39;
import NotePreview from &#39;@/components/NotePreview&#39;
import { useFormStatus } from &#39;react-dom&#39;
import { deleteNote, saveNote } from &#39;../app/actions&#39;

export default function NoteEditor({
  noteId,
  initialTitle,
  initialBody
}) {

  const { pending } = useFormStatus()
  const [title, setTitle] = useState(initialTitle)
  const [body, setBody] = useState(initialBody)
  const isDraft = !noteId

  return (
    &lt;div className=&quot;note-editor&quot;&gt;
      &lt;form className=&quot;note-editor-form&quot; autoComplete=&quot;off&quot;&gt;
        &lt;div className=&quot;note-editor-menu&quot; role=&quot;menubar&quot;&gt;
          &lt;input type=&quot;hidden&quot; name=&quot;noteId&quot; value={noteId} /&gt;
          &lt;button
            className=&quot;note-editor-done&quot;
            disabled={pending}
            type=&quot;submit&quot;
            formAction={saveNote}
            role=&quot;menuitem&quot;
          &gt;
            &lt;img
              src=&quot;/checkmark.svg&quot;
              width=&quot;14px&quot;
              height=&quot;10px&quot;
              alt=&quot;&quot;
              role=&quot;presentation&quot;
            /&gt;
            Done
          &lt;/button&gt;
          {!isDraft &amp;&amp; (
            &lt;button
              className=&quot;note-editor-delete&quot;
              disabled={pending}
              formAction={deleteNote}
              role=&quot;menuitem&quot;
            &gt;
              &lt;img
                src=&quot;/cross.svg&quot;
                width=&quot;10px&quot;
                height=&quot;10px&quot;
                alt=&quot;&quot;
                role=&quot;presentation&quot;
              /&gt;
              Delete
            &lt;/button&gt;
          )}
        &lt;/div&gt;
        &lt;label className=&quot;offscreen&quot; htmlFor=&quot;note-title-input&quot;&gt;
          Enter a title for your note
        &lt;/label&gt;
        &lt;input
          id=&quot;note-title-input&quot;
          type=&quot;text&quot;
          name=&quot;title&quot;
          value={title}
          onChange={(e) =&gt; {
            setTitle(e.target.value)
          }}
        /&gt;
        &lt;label className=&quot;offscreen&quot; htmlFor=&quot;note-body-input&quot;&gt;
          Enter the body for your note
        &lt;/label&gt;
        &lt;textarea
          name=&quot;body&quot;
          value={body}
          id=&quot;note-body-input&quot;
          onChange={(e) =&gt; setBody(e.target.value)}
        /&gt;
      &lt;/form&gt;
      &lt;div className=&quot;note-editor-preview&quot;&gt;
        &lt;div className=&quot;label label--preview&quot; role=&quot;status&quot;&gt;
          Preview
        &lt;/div&gt;
        &lt;h1 className=&quot;note-title&quot;&gt;{title}&lt;/h1&gt;
        &lt;NotePreview&gt;{body}&lt;/NotePreview&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  )
}
</code></pre>
<p><code>app/actions.js</code>çš„ä»£ç ä¸ºï¼š</p>
<pre><code class="language-jsx">&#39;use server&#39;

import { redirect } from &#39;next/navigation&#39;
import {addNote, updateNote, delNote} from &#39;@/lib/redis&#39;;
import { revalidatePath } from &#39;next/cache&#39;;

export async function saveNote(formData) {

  const noteId = formData.get(&#39;noteId&#39;)

  const data = JSON.stringify({
    title: formData.get(&#39;title&#39;),
    content: formData.get(&#39;body&#39;),
    updateTime: new Date()
  })

  if (noteId) {
    updateNote(noteId, data)
    revalidatePath(&#39;/&#39;, &#39;layout&#39;)
    redirect(`/note/${noteId}`)
  } else {
    const res = await addNote(data)
    revalidatePath(&#39;/&#39;, &#39;layout&#39;)
    redirect(`/note/${res}`)
  }

}

export async function deleteNote(formData) {
  const noteId = formData.get(&#39;noteId&#39;)

  delNote(noteId)
  revalidatePath(&#39;/&#39;, &#39;layout&#39;)
  redirect(&#39;/&#39;)
}
</code></pre>
<p>æ­¤æ—¶å†æŸ¥çœ‹ <code>Done</code> å’Œ <code>Delete</code> æŒ‰é’®å…ƒç´ ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e6857c79c55a4225acec50821d46e9c7~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=3592&h=572&s=297615&e=png&b=272727" alt="image.png"></p>
<p>æ­¤æ—¶å°±æ²¡æœ‰åˆšæ‰çš„é”™è¯¯ä¿¡æ¯äº†ã€‚ç°åœ¨è®©æˆ‘ä»¬åœ¨å¼€å‘è€…å·¥å…·ä¸­ç¦ç”¨ JavaScriptï¼Œä½ ä¼šå‘ç°è¡¨å•ä¾ç„¶èƒ½ç”¨ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1576ca606e8940dd81e977ad10ea5c34~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1157&h=660&s=538328&e=gif&f=102&b=fefefe" alt="ReactNotesåœç”¨JS.gif"></p>
<p>å½“ç„¶åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå› ä¸ºç¦ç”¨äº† JavaScriptï¼Œæ‰€ä»¥å·¦ä¾§çš„ç¬”è®°åˆ—è¡¨åŠ è½½ä¸å‡ºæ¥ï¼Œæ›´æ”¹å†…å®¹çš„æ—¶å€™å³è¾¹ä¹Ÿä¸ä¼šå®æ—¶æ¸²æŸ“ï¼Œä½†è‡³å°‘è¡¨å•æäº¤æˆåŠŸäº†ã€‚</p>
<h3>4. useFormState ä¸ useFormStatus</h3>
<p>React çš„ <a href="https://react.dev/reference/react-dom/hooks/useFormState">useFormState</a> å’Œ <a href="useFormStatus">useFormStatus</a> éå¸¸é€‚åˆæ­é… Server Actions ä½¿ç”¨ã€‚<code>useFormState</code> ç”¨äºæ ¹æ® form action çš„ç»“æœæ›´æ–°è¡¨å•çŠ¶æ€ï¼Œ<code>useFormStatus</code> ç”¨äºåœ¨æäº¤è¡¨å•æ—¶æ˜¾ç¤ºå¾…å¤„ç†çŠ¶æ€ã€‚</p>
<p>æ¯”å¦‚ä½¿ç”¨ <code>useFormStatus</code> å®ç°è¡¨å•æäº¤æ—¶æŒ‰é’®çš„ç¦ç”¨æ•ˆæœï¼š</p>
<pre><code class="language-jsx">export default function NoteEditor() {
  const { pending } = useFormStatus()

  return (
    &lt;button disabled={pending}&gt; Done &lt;/button&gt;
  )
}
</code></pre>
<p>åˆæˆ–è€…åœ¨æäº¤çš„æ—¶å€™æŒ‰é’®çš„æ–‡å­—å˜æˆ <code>Saving</code>ï¼š</p>
<pre><code class="language-javascript">export default function NoteEditor() {
  const { pending } = useFormStatus()

  return (
    &lt;button&gt; { pending ? &#39;Saving&#39; : &#39;Done&#39; } &lt;/button&gt;
  )
}
</code></pre>
<p>æ³¨æ„ä½¿ç”¨ <code>useFormStatus</code> çš„æ—¶å€™ï¼Œå»ºè®®å°†æŒ‰é’®æŠ½ç¦»æˆå•ç‹¬çš„ç»„ä»¶ï¼Œåœ¨ç»„ä»¶ä¸­ä½¿ç”¨ <code>useFormStatus</code>ã€‚</p>
<p>ç°åœ¨è®©æˆ‘ä»¬ä¿®æ”¹ä¸‹é¡¹ç›®çš„æ•ˆæœï¼Œå½“ç‚¹å‡» <code>Done</code> çš„æ—¶å€™ï¼Œä¸å†é‡å®šå‘ï¼Œè€Œæ˜¯å‡ºç° <code>Add Success!</code>æç¤ºï¼Œæˆ‘ä»¬å†åŠ å…¥ <code>useFormState</code>é‡å†™ä¸‹ <code>components/NoteEditor.js</code> çš„ä»£ç ï¼š</p>
<pre><code class="language-jsx">&#39;use client&#39;

import { useState } from &#39;react&#39;
import NotePreview from &#39;@/components/NotePreview&#39;
import { useFormState } from &#39;react-dom&#39;
import { deleteNote, saveNote } from &#39;../app/actions&#39;
import SaveButton from &#39;@/components/SaveButton&#39;
import DeleteButton from &#39;@/components/DeleteButton&#39;

const initialState = {
  message: null,
}

export default function NoteEditor({
  noteId,
  initialTitle,
  initialBody
}) {

  const [saveState, saveFormAction] = useFormState(saveNote, initialState)
  const [delState, delFormAction] = useFormState(deleteNote, initialState)

  const [title, setTitle] = useState(initialTitle)
  const [body, setBody] = useState(initialBody)
  
  const isDraft = !noteId

  return (
    &lt;div className=&quot;note-editor&quot;&gt;
      &lt;form className=&quot;note-editor-form&quot; autoComplete=&quot;off&quot;&gt;
        &lt;div className=&quot;note-editor-menu&quot; role=&quot;menubar&quot;&gt;
          &lt;input type=&quot;hidden&quot; name=&quot;noteId&quot; value={noteId} /&gt;
          &lt;SaveButton formAction={saveFormAction} /&gt;
          &lt;DeleteButton isDraft={isDraft} formAction={delFormAction} /&gt;
        &lt;/div&gt;
        &lt;div className=&quot;note-editor-menu&quot;&gt;
          { saveState?.message }
        &lt;/div&gt;
        &lt;label className=&quot;offscreen&quot; htmlFor=&quot;note-title-input&quot;&gt;
          Enter a title for your note
        &lt;/label&gt;
        &lt;input
          id=&quot;note-title-input&quot;
          type=&quot;text&quot;
          name=&quot;title&quot;
          value={title}
          onChange={(e) =&gt; {
            setTitle(e.target.value)
          }}
        /&gt;
        &lt;label className=&quot;offscreen&quot; htmlFor=&quot;note-body-input&quot;&gt;
          Enter the body for your note
        &lt;/label&gt;
        &lt;textarea
          name=&quot;body&quot;
          value={body}
          id=&quot;note-body-input&quot;
          onChange={(e) =&gt; setBody(e.target.value)}
        /&gt;
      &lt;/form&gt;
      &lt;div className=&quot;note-editor-preview&quot;&gt;
        &lt;div className=&quot;label label--preview&quot; role=&quot;status&quot;&gt;
          Preview
        &lt;/div&gt;
        &lt;h1 className=&quot;note-title&quot;&gt;{title}&lt;/h1&gt;
        &lt;NotePreview&gt;{body}&lt;/NotePreview&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  )
}
</code></pre>
<p>æˆ‘ä»¬å°† Done å’Œ Delete æŒ‰é’®æŠ½ç¦»æˆäº†ä¸¤ä¸ªç»„ä»¶ã€‚</p>
<p><code>components/SaveButton.js</code>ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">import { useFormStatus } from &#39;react-dom&#39;

export default function EditButton({ formAction }) {
  const { pending } = useFormStatus()
  return (
    &lt;button
      className=&quot;note-editor-done&quot;
      type=&quot;submit&quot;
      formAction={formAction}
      disabled={pending}
      role=&quot;menuitem&quot;
    &gt;
      &lt;img
        src=&quot;/checkmark.svg&quot;
        width=&quot;14px&quot;
        height=&quot;10px&quot;
        alt=&quot;&quot;
        role=&quot;presentation&quot;
      /&gt;
      {pending ? &#39;Saving&#39; : &#39;Done&#39;}
    &lt;/button&gt;
  );
}
</code></pre>
<p><code>components/DeleteButton.js</code>ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">import { useFormStatus } from &#39;react-dom&#39;

export default function DeleteButton({ isDraft, formAction }) {
  const { pending } = useFormStatus()
  return !isDraft &amp;&amp; (
      &lt;button
        className=&quot;note-editor-delete&quot;
        disabled={pending}
        formAction={formAction}
        role=&quot;menuitem&quot;
      &gt;
        &lt;img
          src=&quot;/cross.svg&quot;
          width=&quot;10px&quot;
          height=&quot;10px&quot;
          alt=&quot;&quot;
          role=&quot;presentation&quot;
        /&gt;
        Delete
      &lt;/button&gt;
    )
}
</code></pre>
<p><code>app/actions.js</code>çš„ä»£ç ä¸ºï¼š</p>
<pre><code class="language-jsx">&#39;use server&#39;

import { redirect } from &#39;next/navigation&#39;
import {addNote, updateNote, delNote} from &#39;@/lib/redis&#39;;
import { revalidatePath } from &#39;next/cache&#39;;
const sleep = ms =&gt; new Promise(r =&gt; setTimeout(r, ms));

export async function saveNote(prevState, formData) {

  const noteId = formData.get(&#39;noteId&#39;)

  const data = JSON.stringify({
    title: formData.get(&#39;title&#39;),
    content: formData.get(&#39;body&#39;),
    updateTime: new Date()
  })

  // ä¸ºäº†è®©æ•ˆæœæ›´æ˜æ˜¾
  await sleep(2000)

  if (noteId) {
    updateNote(noteId, data)
    revalidatePath(&#39;/&#39;, &#39;layout&#39;)
  } else {
    const res = await addNote(data)
    revalidatePath(&#39;/&#39;, &#39;layout&#39;)
  }
  return { message: `Add Success!` }
}

export async function deleteNote(prevState, formData) {
  const noteId = formData.get(&#39;noteId&#39;)
  delNote(noteId)
  revalidatePath(&#39;/&#39;, &#39;layout&#39;)
  redirect(&#39;/&#39;)
}
</code></pre>
<p>æ­¤æ—¶å†ç‚¹å‡» <code>Done</code> æŒ‰é’®ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/758a736d094747e9a0affeb44aa8067f~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1157&h=660&s=117591&e=gif&f=33&b=fefefe" alt="ReactNotes-useForm.gif">
å½“ç‚¹å‡» <code>Done</code> æŒ‰é’®çš„æ—¶å€™ï¼Œ<code>Done</code> å’Œ <code>Delete</code> æŒ‰é’®éƒ½å‡ºç°äº† disabled æ ·å¼ï¼ˆæ¯•ç«Ÿè¿™ä¸¤ä¸ªæŒ‰é’®åœ¨ä¸€ä¸ªè¡¨å•å†…ï¼‰ï¼Œ2s åï¼Œå‡ºç° Add Success! æç¤ºã€‚</p>
<h3>5. æ•°æ®æ ¡éªŒ</h3>
<p>å¦‚æœéœ€è¦å¯¹æ•°æ®è¿›è¡Œæ ¡éªŒï¼ŒNext.js æ¨èä½¿ç”¨ <a href="https://zod.dev/README_ZH">zod</a>ï¼Œæˆ‘ä»¬ä½¿ç”¨  zod ä¿®æ”¹ä¸‹ <code>/app/actions.js</code>ï¼š</p>
<pre><code class="language-javascript">&#39;use server&#39;

import { redirect } from &#39;next/navigation&#39;
import {addNote, updateNote, delNote} from &#39;@/lib/redis&#39;;
import { revalidatePath } from &#39;next/cache&#39;;
import { z } from &quot;zod&quot;;

const schema = z.object({
  title: z.string(),
  content: z.string().min(1, &#39;è¯·å¡«å†™å†…å®¹&#39;).max(100, &#39;å­—æ•°æœ€å¤š 100&#39;)
});

const sleep = ms =&gt; new Promise(r =&gt; setTimeout(r, ms));

export async function saveNote(prevState, formData) {

  // è·å– noteId
  const noteId = formData.get(&#39;noteId&#39;)
  const data = {
    title: formData.get(&#39;title&#39;),
    content: formData.get(&#39;body&#39;),
    updateTime: new Date()
  }

  // æ ¡éªŒæ•°æ®
  const validated = schema.safeParse(data)
  if (!validated.success) {
    return {
      errors: validated.error.issues,
    }
  }

  // æ¨¡æ‹Ÿè¯·æ±‚æ—¶é—´
  await sleep(2000)

  // æ›´æ–°æ•°æ®åº“
  if (noteId) {
    await updateNote(noteId, JSON.stringify(data))
    revalidatePath(&#39;/&#39;, &#39;layout&#39;)
  } else {
    await addNote(JSON.stringify(data))
    revalidatePath(&#39;/&#39;, &#39;layout&#39;)
  }
  
  return { message: `Add Success!` }
}

export async function deleteNote(prevState, formData) {
  const noteId = formData.get(&#39;noteId&#39;)
  delNote(noteId)
  revalidatePath(&#39;/&#39;, &#39;layout&#39;)
  redirect(&#39;/&#39;)
}
</code></pre>
<p><code>components/NoteEditor.js</code>ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">&#39;use client&#39;

import { useEffect, useRef, useState } from &#39;react&#39;
import NotePreview from &#39;@/components/NotePreview&#39;
import { useFormState } from &#39;react-dom&#39;
import { deleteNote, saveNote } from &#39;../app/actions&#39;
import SaveButton from &#39;@/components/SaveButton&#39;
import DeleteButton from &#39;@/components/DeleteButton&#39;

const initialState = {
  message: null,
}

export default function NoteEditor({
  noteId,
  initialTitle,
  initialBody
}) {

  const [saveState, saveFormAction] = useFormState(saveNote, initialState)
  const [delState, delFormAction] = useFormState(deleteNote, initialState)

  const [title, setTitle] = useState(initialTitle)
  const [body, setBody] = useState(initialBody)

  const isDraft = !noteId

  useEffect(() =&gt; {
    if (saveState.errors) {
      // å¤„ç†é”™è¯¯
      console.log(saveState.errors)
    }
  }, [saveState])

  return (
    &lt;div className=&quot;note-editor&quot;&gt;
      &lt;form className=&quot;note-editor-form&quot; autoComplete=&quot;off&quot;&gt;
        &lt;input type=&quot;hidden&quot; name=&quot;noteId&quot; value={noteId || &#39;&#39;} /&gt;
        &lt;div className=&quot;note-editor-menu&quot; role=&quot;menubar&quot;&gt;
          &lt;SaveButton formAction={saveFormAction} /&gt;
          &lt;DeleteButton isDraft={isDraft} formAction={delFormAction} /&gt;
        &lt;/div&gt;
        &lt;div className=&quot;note-editor-menu&quot;&gt;
          { saveState?.message }
          { saveState.errors &amp;&amp; saveState.errors[0].message }
        &lt;/div&gt;
        &lt;label className=&quot;offscreen&quot; htmlFor=&quot;note-title-input&quot;&gt;
          Enter a title for your note
        &lt;/label&gt;
        &lt;input
          id=&quot;note-title-input&quot;
          type=&quot;text&quot;
          name=&quot;title&quot;
          value={title}
          onChange={(e) =&gt; {
            setTitle(e.target.value)
          }}
        /&gt;
        &lt;label className=&quot;offscreen&quot; htmlFor=&quot;note-body-input&quot;&gt;
          Enter the body for your note
        &lt;/label&gt;
        &lt;textarea
          name=&quot;body&quot;
          value={body}
          id=&quot;note-body-input&quot;
          onChange={(e) =&gt; setBody(e.target.value)}
        /&gt;
      &lt;/form&gt;
      &lt;div className=&quot;note-editor-preview&quot;&gt;
        &lt;div className=&quot;label label--preview&quot; role=&quot;status&quot;&gt;
          Preview
        &lt;/div&gt;
        &lt;h1 className=&quot;note-title&quot;&gt;{title}&lt;/h1&gt;
        &lt;NotePreview&gt;{body}&lt;/NotePreview&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  )
}
</code></pre>
<p>å®ç°æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/41d5ea8c54184771beafaac2f15af67f~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1157&h=672&s=189476&e=gif&f=71&b=f3f5f9" alt="ReactNotes-zod.gif"></p>
<h3>6. æœ€ä½³å®è·µï¼šServer Actions</h3>
<p>å†™ Server Actions åŸºæœ¬è¦æ³¨æ„çš„ç‚¹å°±è¿™äº›äº†ï¼Œå®šä¹‰åœ¨ actions çš„ä»£ç è¦æ³¨æ„ï¼š</p>
<ol>
<li>ä» <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FormData/FormData">formData</a> ä¸­è·å–æäº¤çš„æ•°æ®</li>
<li>ä½¿ç”¨ <a href="https://zod.dev/README_ZH">zod</a> è¿›è¡Œæ•°æ®æ ¡éªŒ</li>
<li>ä½¿ç”¨ <a href="https://juejin.cn/book/7307859898316881957/section/7309079586296791050#heading-12">revalidate</a> æ›´æ–°æ•°æ®ç¼“å­˜</li>
<li>è¿”å›åˆé€‚çš„ä¿¡æ¯</li>
</ol>
<p>å®šä¹‰è¡¨å•çš„ä»£ç è¦æ³¨æ„ï¼š</p>
<ol>
<li>æ­é…ä½¿ç”¨ <a href="https://react.dev/reference/react-dom/hooks/useFormState">useFormState</a> å’Œ <a href="useFormStatus">useFormStatus</a></li>
<li>ç‰¹æ®Šæ•°æ®ä½¿ç”¨éšè— input æäº¤</li>
</ol>
<h2>æ€»ç»“</h2>
<p>é‚£ä¹ˆä»Šå¤©çš„å†…å®¹å°±ç»“æŸäº†ï¼Œæœ¬ç¯‡æˆ‘ä»¬å®Œå–„äº†ç¬”è®°çš„ç¼–è¾‘æ•ˆæœï¼Œäº†è§£äº†å®¢æˆ·ç«¯ç»„ä»¶ä¸æœåŠ¡ç«¯ç»„ä»¶çš„åˆ’åˆ†ä»¥åŠåœ¨å®æˆ˜ä¸­ä½¿ç”¨ Server Actionsï¼Œå­¦ä¹ ä¹¦å†™ Server Actions æ—¶çš„æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µã€‚</p>
<p>æœ¬ç¯‡çš„ä»£ç æˆ‘å·²ç»ä¸Šä¼ åˆ°<a href="https://github.com/mqyqingfeng/next-react-notes-demo/tree/main">ä»£ç ä»“åº“</a>çš„ Day 4 åˆ†æ”¯ï¼š<a href="https://github.com/mqyqingfeng/next-react-notes-demo/tree/day4">https://github.com/mqyqingfeng/next-react-notes-demo/tree/day4</a>ï¼Œæœ¬ç¯‡çš„ä¸åŒç‰ˆæœ¬ä»¥ä¸åŒçš„ commit è¿›è¡Œäº†æäº¤ï¼Œæ­¤å¤–ç›´æ¥ä½¿ç”¨çš„æ—¶å€™ä¸è¦å¿˜è®°åœ¨æœ¬åœ°å¼€å¯ Redisã€‚</p>

</body>
</html>
  