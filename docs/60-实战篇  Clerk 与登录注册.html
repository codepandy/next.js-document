
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>60-实战篇  Clerk 与登录注册</title>
  <style>
    body {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
    }
    pre {
      background-color: #f6f8fa;
      padding: 16px;
      border-radius: 6px;
      overflow: auto;
    }
    code {
      font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
    }
  </style>
</head>
<body>
<h2>前言</h2>
<p>登录与注册，一个说简单也简单，说复杂也复杂的功能。</p>
<p>往简单的说，注册的时候搞两个输入框，将数据写入数据库，登录的时候校验一下数据是否正确即可。</p>
<p>往复杂的说，除了登录注册，还有账号注销、忘记密码、密码重置、邮箱验证、更新个人资料、更新密码、删除账号等功能，此外，数据的安全性如何保证？Magic Links、Multi-Factor Auth (MFA)、社交媒体登录 (Google, Facebook, Twitter, GitHub, Apple, and more) 是否要支持？是不是还要做个后台统计用户登录数据？想一想都是工作量。</p>
<p>所以虽然可以自己从头做，但有现成的还是用现成的吧。</p>
<p>所幸关于登录注册的技术方案，并不像评论系统那么多，推荐 3 个主流的技术选型：</p>
<ol>
<li><a href="https://clerk.com/"><strong>Clerk</strong></a></li>
</ol>
<blockquote>
<p>The most comprehensive User Management Platform</p>
</blockquote>
<p>Clerk 提供了一个开发人员友好的身份验证和用户管理解决方案，帮助开发者轻松构建和管理用户身份验证、用户账户和权限管理功能。它提供了安全的身份验证、社交登录集成、角色和权限管理等功能。</p>
<ol start="2">
<li><a href="https://supabase.com/"><strong>Supabase</strong></a></li>
</ol>
<blockquote>
<p>Supabase is an open source Firebase alternative.</p>
</blockquote>
<blockquote>
<p>Start your project with a Postgres database, Authentication, instant APIs, Edge Functions, Realtime subscriptions, Storage, and Vector embeddings.</p>
</blockquote>
<p>简单来说，Supabase 是 Firebase 的开源替代品，属于 BaaS（后端即服务）产品。所谓 BaaS，开发者只需要开发和维护前端代码，由 BaaS 服务商提供了开发应用所需要的后端服务，如用户身份验证、数据库管理、推送通知（针对移动应用程序），以及云存储和托管等。</p>
<p>此外，Supabase 建立在 Postgres 之上。Postgres 是一个免费的开源数据库，被认为是世界上最稳定、最先进的数据库之一。</p>
<p>所以用户身份验证只是 Supabase 提供的功能之一。</p>
<p>如果要比较 Clerk 和 Supabse 的话，Clerk 更专注于身份验证和用户管理，对应功能更加丰富。Supabase 实现的功能更多，身份验证只是其中之一。</p>
<p>实际使用的时候，两者也可以一起使用。Clerk 和 Supabse 各自提供了接入对方的文档：</p>
<ol>
<li><a href="https://clerk.com/docs/integrations/databases/supabase">Clerk：Integrate Supabase with Clerk</a></li>
<li><a href="https://supabase.com/partners/integrations/clerk">Supabase：Integrate Clerk</a></li>
</ol>
<p>注意：这两个平台都提供了免费版，但免费版毕竟有一些限制，比如 Clerk 会限制 10000 月活跃用户等，Supabse 会限制 50000 月活跃用户，数据库大小为 500 MB 等等。</p>
<ol start="3">
<li><a href="https://next-auth.js.org/getting-started/introduction"><strong>Next-Auth</strong></a></li>
</ol>
<p>我们在<a href="https://juejin.cn/book/7307859898316881957/section/7317925907765657638">《实战篇 | React Notes | next-auth》</a>介绍的便是 Next-Auth，Next-auth 不是平台，是一个开源库，可以帮助我们快速实现登录注册等功能。</p>
<p>总的来说，如果要快速接入登录注册功能，最好还是使用平台，也就是 Clerk 和 Supabse，其中 Clerk 提供的功能更为丰富，但免费版月活限制用户数更少。</p>
<p>本篇我们对 Clerk 的使用进行讲解。</p>
<h2>Clerk</h2>
<h3>1. Clerk 注册并创建应用</h3>
<p>打开 <a href="https://clerk.com/">https://clerk.com/</a> 注册一个账号，首次登录后会进入创建应用界面：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/91000aed3a344c5098eafd1e09107741~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=3414&h=2088&s=525729&e=png&b=ffffff" alt="image.png"></p>
<p>输入应用的名字，左边选择支持的登录方式，右边为预览登录界面 UI，样式会根据左边的选择有所不同。</p>
<p>创建应用后，会跳转到 Get started 页面，指导用户如何接入 Clerk：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/46bada6c507f4faa9886936f3fabb4d1~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=3878&h=2090&s=687809&e=png&b=ffffff" alt="image.png"></p>
<h3>2. 接入 Clerk</h3>
<p>为了演示如何<a href="https://clerk.com/docs/quickstarts/nextjs">接入 Clerk</a>，我们使用官方脚手架创建一个新项目：</p>
<pre><code class="language-bash">npx create-next-app@latest
</code></pre>
<p>项目安装依赖项：</p>
<pre><code class="language-bash">npm install @clerk/nextjs
</code></pre>
<p>添加本地环境变量：</p>
<pre><code class="language-bash">NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_xxxxxxxxxxxxxxxxxxxxxxxxx
CLERK_SECRET_KEY=sk_test_xxxxxxxxxxxxxxxxxxxxxxxxx
</code></pre>
<p>新建 <code>middleware.js</code>，代码如下：</p>
<pre><code class="language-javascript">import { clerkMiddleware } from &quot;@clerk/nextjs/server&quot;;

export default clerkMiddleware();

export const config = {
  matcher: [&quot;/((?!.*\\..*|_next).*)&quot;, &quot;/&quot;, &quot;/(api|trpc)(.*)&quot;],
};
</code></pre>
<p>修改 <code>app/layout.jsx</code>，代码如下：</p>
<pre><code class="language-jsx">import {
  ClerkProvider,
  SignInButton,
  SignedIn,
  SignedOut,
  UserButton
} from &#39;@clerk/nextjs&#39;
import &#39;./globals.css&#39;
export default function RootLayout({
  children,
}) {
  return (
    &lt;ClerkProvider&gt;
      &lt;html lang=&quot;en&quot;&gt;
        &lt;body&gt;
          &lt;SignedOut&gt;
            &lt;SignInButton /&gt;
          &lt;/SignedOut&gt;
          &lt;SignedIn&gt;
            &lt;UserButton /&gt;
          &lt;/SignedIn&gt;
          {children}
        &lt;/body&gt;
      &lt;/html&gt;
    &lt;/ClerkProvider&gt;
  )
}
</code></pre>
<p>解释下这段代码中用到的组件：</p>
<p>所有 Clerk hooks 和组件都必须是 <code>&lt;ClerkProvider&gt;</code> 的子组件，所以我们用 <code>&lt;ClerkProvider&gt;</code> 将整个页面代码包裹，该组件会存储 session 和用户上下文数据。</p>
<p><code>&lt;SignedIn&gt;</code>下的子组件仅在登录状态时显示。<code>&lt;SignedOut&gt;</code>下的子组件仅在非登录状态时显示。</p>
<p><code>&lt;SignInButton&gt;</code> 是一个链接至登录页面的无样式组件。<code>&lt;UserButton&gt;</code>是一个 Clerk 提供的自带样式的组件，用于展示用户头像。</p>
<p>此时我们就实现了 Clerk 的接入，并已经实现了账号的登录、注册、账号管理、注销等功能。</p>
<p>打开 <a href="http://localhost:3000/">http://localhost:3000/</a>，浏览器效果如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0ea058d2522d491a8feacf7dc87617e5~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1353&h=976&s=866418&e=gif&f=146&b=fdfdfd" alt="4.gif"></p>
<h3>3. 添加中文</h3>
<p>从上图可以发现，虽然 Clerk 实现了登录注册的功能，但有一个问题，那就是界面都是英文，如何改成中文界面呢？Clerk 也考虑到了这一点，并提供了<a href="https://clerk.com/docs/components/customization/localization">本地化方法</a>。</p>
<p>安装依赖项：</p>
<pre><code class="language-bash">npm install @clerk/localizations
</code></pre>
<p>修改 <code>app/layout.js</code>，代码如下：</p>
<pre><code class="language-jsx">import {
  ClerkProvider,
  SignInButton,
  SignedIn,
  SignedOut,
  UserButton
} from &#39;@clerk/nextjs&#39;
import &#39;./globals.css&#39;
import { zhCN } from &quot;@clerk/localizations&quot;;

export default function RootLayout({
  children,
}) {
  return (
    &lt;ClerkProvider localization={zhCN}&gt;
      &lt;html lang=&quot;zh-CN&quot;&gt;
        &lt;body&gt;
          &lt;SignedOut&gt;
            &lt;SignInButton mode=&quot;modal&quot;&gt;
              登录
            &lt;/SignInButton&gt;
          &lt;/SignedOut&gt;
          &lt;SignedIn&gt;
            &lt;UserButton showName={true} /&gt;
          &lt;/SignedIn&gt;
          {children}
        &lt;/body&gt;
      &lt;/html&gt;
    &lt;/ClerkProvider&gt;
  )
}
</code></pre>
<p>此时浏览器效果如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7d6b22f41eec4b2396ee8e8a8b18be3d~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1353&h=976&s=801725&e=gif&f=132&b=fdfdfd" alt="5.gif"></p>
<p>注意：这里<code>&lt;SignInButton&gt;</code> 的 <code>mode</code> 设置为了 <code>&quot;modal&quot;</code> 才让登录界面的本地化生效。如果不设置为 modal 则会直接跳转到登录界面，此时本地化不会生效。如果让跳转登录界面也实现本地化的话，可以参考接下来讲到的 Next-js-Boilerplate 的实现方式。</p>
<h3>4. 后台界面</h3>
<p>Clerk 提供了后台界面，可以查看登录用户数据以及进行登录相关的设置：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/28698b3eea6b44249a1f4240451feec0~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=3872&h=2124&s=622794&e=png&b=ffffff" alt="image.png"></p>
<p>当然，Clerk 实现的功能远不止如此，你可以完全自定义登录界面、使用内置的组件自定义开发、构架自己的登录流程等等，Clerk 都提供了详细的文档：<a href="https://clerk.com/docs">https://clerk.com/docs</a></p>
<h2>Next-js-Boilerplate</h2>
<p>既然我们已经知道了 Next.js 项目如何接入 Clerk，那回到我们之前讲到的 Next-js-Boilerplate 模板。</p>
<h3>1. 基础设置</h3>
<p>在这个模板中使用 Clerk，最基础的就是设置 <code>NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY</code> 和 <code>CLERK_SECRET_KEY</code>。</p>
<blockquote>
<p>从安全的角度来讲，应该将 <code>NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY</code> 放到 <code>.env</code>文件中，<code>CLERK_SECRET_KEY</code> 放到 <code>.env.local</code>文件中，并且 Git 不提交 <code>.env.local</code></p>
</blockquote>
<h3>2. 登录路由</h3>
<p>但与之前简易接入 Clerk 的方式不同，在 Next-js-Boilerplate 中，当用户点击 Sign In 的时候，跳转的并不是 Clerk 的登录页面，而是 <a href="http://localhost:3000/sign-in">http://localhost:3000/sign-in</a>，这是因为在 <code>.env</code>中，我们通过 <code>CLERK_SIGN_IN_URL</code> 环境变量重新设置了登录的跳转地址：</p>
<pre><code class="language-bash">NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
</code></pre>
<p>查看 <code>/sign-in</code>路由对应的文件代码，打开 <code>src/app/[locale]/(auth)/(center)/sign-in/[[...sign-in]]/page.tsx</code>：</p>
<pre><code class="language-tsx">import { SignIn } from &#39;@clerk/nextjs&#39;;
import { getTranslations } from &#39;next-intl/server&#39;;
import { getI18nPath } from &#39;@/utils/Helpers&#39;;

// ...

const SignInPage = (props: { params: { locale: string } }) =&gt; (
  &lt;SignIn path={getI18nPath(&#39;/sign-in&#39;, props.params.locale)} /&gt;
);

export default SignInPage;
</code></pre>
<p>在这个页面路由中，我们使用了 Clerk 提供的 <code>&lt;SignIn&gt;</code> 组件来渲染登录界面，其中 <code>path</code> 属性用来设置组件挂载的路径。</p>
<h3>3. 中文设置</h3>
<p>如果我们的 Next-js-Boilerplate 要实现默认中文登录界面的效果，该如何实现呢？</p>
<p>首先，修改 <code>src/utils/AppConfig.ts</code>，完整代码如下：</p>
<pre><code class="language-typescript">import type { LocalePrefix } from &#39;node_modules/next-intl/dist/types/src/shared/types&#39;;

const localePrefix: LocalePrefix = &#39;as-needed&#39;;

export const AppConfig = {
  name: &#39;Nextjs Starter&#39;,
  locales: [&#39;zh&#39;, &#39;en&#39;],
  defaultLocale: &#39;zh&#39;,
  localePrefix,
};
</code></pre>
<p>然后修改 <code>src/app/[locale]/(auth)/layout.tsx</code>，完整代码如下：</p>
<pre><code class="language-tsx">import { enUS, zhCN } from &#39;@clerk/localizations&#39;;
import { ClerkProvider } from &#39;@clerk/nextjs&#39;;

export default function AuthLayout(props: {
  children: React.ReactNode;
  params: { locale: string };
}) {
  let clerkLocale = zhCN;
  let signInUrl = &#39;/sign-in&#39;;
  let signUpUrl = &#39;/sign-up&#39;;
  let dashboardUrl = &#39;/dashboard&#39;;

  if (props.params.locale === &#39;en&#39;) {
    clerkLocale = enUS;
  }

  if (props.params.locale !== &#39;zh&#39;) {
    signInUrl = `/${props.params.locale}${signInUrl}`;
    signUpUrl = `/${props.params.locale}${signUpUrl}`;
    dashboardUrl = `/${props.params.locale}${dashboardUrl}`;
  }

  return (
    &lt;ClerkProvider
      localization={clerkLocale}
      signInUrl={signInUrl}
      signUpUrl={signUpUrl}
      signInFallbackRedirectUrl={dashboardUrl}
      signUpFallbackRedirectUrl={dashboardUrl}
      &gt;
      {props.children}
    &lt;/ClerkProvider&gt;
  );
}
</code></pre>
<p>最后，添加翻译文件，新建 <code>src/locales/zh.json</code>，代码如下：</p>
<pre><code class="language-javascript">{
  &quot;RootLayout&quot;: {
    &quot;home_link&quot;: &quot;主页&quot;,
    &quot;about_link&quot;: &quot;关于&quot;,
    &quot;guestbook_link&quot;: &quot;Guestbook&quot;,
    &quot;portfolio_link&quot;: &quot;Portfolio&quot;,
    &quot;sign_in_link&quot;: &quot;登录&quot;,
    &quot;sign_up_link&quot;: &quot;注册&quot;
  },
  // ...
</code></pre>
<p>当然在这里我们只翻译了登录相关的文字，其他内容的翻译我们会在下篇借助 CrowdIn 来实现。</p>
<p>此时浏览器效果如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/75584a3120d84ef8a41bef6f18795d56~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1357&h=814&s=291796&e=gif&f=74&b=fefefe" alt="6.gif"></p>
<h2>总结</h2>
<p>登录注册所代表的鉴权功能，主流技术选型有 3 个：Clerk、Supabase 和 Next-Auth。其不同之处在于 Clerk 专注于用户管理，Supabse 是 BaaS 产品，鉴权是其中一个功能。Next-Auth 是一个开源库，需要自己实现数据库等。</p>
<p>总的来说，为了快速接入，会优先选择接入 Clerk 和 Supabase，这两个平台自带数据库实现，但免费版都有一些限制。但两者也不冲突，Clerk 和 Supabse 可以一起使用。</p>
<p>本篇我们在本地化的时候，只翻译了很小一部分内容，下一篇我们会借助 CrowdIn 平台实现所有内容的自动翻译。</p>

</body>
</html>
  